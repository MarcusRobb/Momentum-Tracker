<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Momentum: Time Boxing & LAPS Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM from CDN (UMD builds) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <!-- The root element for the React app -->
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useCallback, useEffect, useMemo, useRef } = React;

      // UUID generation with fallback for older browsers
      const generateUUID = () => {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) {
          return crypto.randomUUID();
        }
        // Fallback for older browsers
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0;
          const v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      };

      // useLocalStorage hook
      const useLocalStorage = (key, initialValue) => {
        const [storedValue, setStoredValue] = useState(() => {
          if (typeof window === 'undefined') {
            return initialValue;
          }
          try {
            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
          } catch (error) {
            console.error(error);
            return initialValue;
          }
        });

        const setValue = (value) => {
          try {
            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            if (typeof window !== 'undefined') {
              window.localStorage.setItem(key, JSON.stringify(valueToStore));
            }
          } catch (error) {
            console.error(error);
          }
        };

        useEffect(() => {
          const handleStorageChange = (e) => {
            if (e.key === key && e.newValue) {
              setStoredValue(JSON.parse(e.newValue));
            }
          };
          window.addEventListener('storage', handleStorageChange);
          return () => window.removeEventListener('storage', handleStorageChange);
        }, [key]);

        return [storedValue, setValue];
      };

      // Icon Components
      const PlusIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      );

      const TrashIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      );

      const ArrowUpCircleIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="16 12 12 8 8 12"></polyline>
          <line x1="12" y1="16" x2="12" y2="8"></line>
        </svg>
      );

      const ArrowDownCircleIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="8 12 12 16 16 12"></polyline>
          <line x1="12" y1="8" x2="12" y2="16"></line>
        </svg>
      );

      const ChevronDownIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      );

      const ChevronUpIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <polyline points="18 15 12 9 6 15"></polyline>
        </svg>
      );

      const DollarSignIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <line x1="12" y1="1" x2="12" y2="23"></line>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
      );

      const CalendarIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      );

      const RestoreIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M9 14l-4-4 4-4"></path>
          <path d="M5 10h11a4 4 0 0 1 4 4v1"></path>
        </svg>
      );

      const LightbulbIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M9 18h6"></path>
          <path d="M10 22h4"></path>
          <path d="M12 2a7 7 0 0 0-7 7c0 3.03 1.09 5.4 2.78 6.88L12 22l4.22-6.12C17.91 14.4 19 11.03 19 9a7 7 0 0 0-7-7z"></path>
        </svg>
      );

      const SparkleIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M12 2L9.1 8.26 3 9.27l4.55 4.34L6.2 20 12 16.54 17.8 20l-1.35-6.39L21 9.27l-6.1-1.01L12 2z"></path>
          <path d="M5 3v4"></path>
          <path d="M19 17v4"></path>
          <path d="M3 5h4"></path>
          <path d="M17 19h4"></path>
        </svg>
      );

      // Instructions Component
      const Instructions = () => {
        const [isOpen, setIsOpen] = useState(false);

        return (
          <div className="bg-white rounded-lg shadow-sm mb-8">
            <button
              onClick={() => setIsOpen(!isOpen)}
              className="w-full flex justify-between items-center p-4 text-left text-lg font-semibold text-slate-700 focus:outline-none"
            >
              <span>Time Boxing Instructions & Tips</span>
              <ChevronDownIcon className={`w-6 h-6 transform transition-transform ${isOpen ? 'rotate-180' : ''}`} />
            </button>
            {isOpen && (
              <div className="p-6 border-t border-slate-200 text-slate-700">
                <p className="text-base mb-4">
                  Here's a ripper strategy to keep you focused and make sure you're raking in the cash. It's all about being intentional and focused on actions that drive real results for your business.
                </p>
                
                <h4 className="font-semibold text-slate-800 text-lg mb-3">Step-by-Step Instructions</h4>
                <ol className="list-decimal list-outside pl-5 space-y-3 mb-6">
                  <li>
                    <strong className="font-semibold text-slate-900">Brain Dump Everything You Need to Do:</strong> Grab a blank piece of paper and jot down absolutely all the tasks running through your head.
                    <em className="block text-sm text-slate-500 pl-2 border-l-2 border-slate-200 ml-2 mt-1 italic">Tip: This should be a fresh brain dump every single day.</em>
                  </li>
                  <li>
                    <strong className="font-semibold text-slate-900">Select Your Top Three Tasks:</strong> From your list, circle just three items to focus on. 
                    <em className="block text-sm text-slate-500 pl-2 border-l-2 border-slate-200 ml-2 mt-1 italic">Crucial Step: One of these three tasks must be a direct income-generating activity (e.g., talking to a customer, closing a deal, sending offers).</em>
                  </li>
                  <li>
                    <strong className="font-semibold text-slate-900">Schedule These Three Tasks:</strong> Book specific times in your calendar for each task. 
                    <em className="block text-sm text-slate-500 pl-2 border-l-2 border-slate-200 ml-2 mt-1 italic">Tip: This creates an appointment with yourself for accountability.</em>
                  </li>
                  <li>
                    <strong className="font-semibold text-slate-900">Detail Action Points for Each Task:</strong> In the notes for each scheduled task, create a bullet-point list of the specific actions required. 
                    <em className="block text-sm text-slate-500 pl-2 border-l-2 border-slate-200 ml-2 mt-1 italic">Tip: This pre-planning removes hesitation.</em>
                  </li>
                  <li>
                    <strong className="font-semibold text-slate-900">Execute Your Plan:</strong> When the time comes, show up and get it done. You learn by doing.
                  </li>
                </ol>

                <h4 className="font-semibold text-slate-800 text-lg mb-3">Key Tips for Success</h4>
                <ul className="list-disc list-outside pl-5 space-y-2">
                  <li><strong className="font-semibold text-slate-900">Consistency is King:</strong> This exercise takes 3-5 minutes a day. Do it religiously.</li>
                  <li><strong className="font-semibold text-slate-900">Focus on Income-Generating Activities:</strong> Ask yourself: "Is what I'm doing right now putting cash in my bank today?".</li>
                  <li><strong className="font-semibold text-slate-900">Track Your Progress:</strong> Use the LAPS sheet (Leads, Appointments, Presentations, Sales) daily.</li>
                  <li><strong className="font-semibold text-slate-900">Dedicate Specific Time:</strong> Allocate at least one hour per day to these focused, income-generating actions.</li>
                  <li><strong className="font-semibold text-slate-900">Don't Overthink It:</strong> This is a "just do" moment. Action leads to clarity.</li>
                  <li><strong className="font-semibold text-slate-900">Learn by Doing:</strong> You get better by doing the work and getting feedback, not just by strategising.</li>
                </ul>
              </div>
            )}
          </div>
        );
      };

      // TaskCard Component
      const TaskCard = ({ task, onUpdate, onDelete, onPromote, onDemote, onSendToVault, onLaunchGemini, isTopThree }) => {
        const handleToggle = (field, value) => {
          onUpdate({ ...task, [field]: value });
        };

        const handleAddToCalendar = () => {
          if (!task.scheduledTime || task.scheduledTime.match(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/) === null) {
            alert("Please set a valid time for the task first.");
            return;
          }

          const [hours, minutes] = task.scheduledTime.split(':').map(Number);

          const startTime = new Date();
          startTime.setHours(hours, minutes, 0, 0);

          const durationMinutes = task.duration || 60;
          const endTime = new Date(startTime.getTime() + durationMinutes * 60 * 1000);

          const toGoogleFormat = (date) => {
            return date.toISOString().replace(/-|:|\.\d{3}/g, '');
          };

          const calendarUrl = new URL('https://www.google.com/calendar/render');
          calendarUrl.searchParams.append('action', 'TEMPLATE');
          calendarUrl.searchParams.append('text', task.text);
          calendarUrl.searchParams.append('dates', `${toGoogleFormat(startTime)}/${toGoogleFormat(endTime)}`);
          calendarUrl.searchParams.append('details', task.notes || `Completing task: ${task.text}`);
          calendarUrl.searchParams.append('crm', 'BUSY');

          window.open(calendarUrl.toString() + '&colorId=11', '_blank', 'noopener,noreferrer');
        };

        return (
          <div className="p-4 rounded-lg flex items-start gap-4 transition-all bg-white border border-slate-200">
            <input
              type="checkbox"
              checked={task.isCompleted}
              onChange={(e) => handleToggle('isCompleted', e.target.checked)}
              className="mt-1 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              aria-label="Mark task as complete"
            />
            <div className="flex-1">
              <p className="font-medium text-slate-800">{task.text}</p>
              {isTopThree && (
                <div className="mt-3 space-y-3">
                  <div className="grid grid-cols-2 gap-2">
                    <input
                      type="time"
                      value={task.scheduledTime}
                      onChange={(e) => handleToggle('scheduledTime', e.target.value)}
                      className="block w-full text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500 focus:border-blue-500"
                      aria-label="Scheduled time"
                    />
                    <select
                      value={task.duration || 60}
                      onChange={(e) => handleToggle('duration', Number(e.target.value))}
                      className="block w-full text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500 focus:border-blue-500"
                      aria-label="Task duration"
                    >
                      <option value="15">15 mins</option>
                      <option value="30">30 mins</option>
                      <option value="45">45 mins</option>
                      <option value="60">1 hour</option>
                      <option value="90">1.5 hours</option>
                      <option value="120">2 hours</option>
                    </select>
                  </div>
                  <button
                    onClick={handleAddToCalendar}
                    title="Add to Google Calendar"
                    className="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 hover:text-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled={!task.scheduledTime}
                    aria-label="Add to Google Calendar"
                  >
                    <CalendarIcon className="w-5 h-5" />
                    <span>Add to Calendar</span>
                  </button>
                  <textarea
                    placeholder="Action points & notes..."
                    value={task.notes}
                    onChange={(e) => handleToggle('notes', e.target.value)}
                    rows={3}
                    className="block w-full text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500 focus:border-blue-500"
                    aria-label="Task notes"
                  />
                  <button
                    onClick={() => handleToggle('isIncomeGenerating', !task.isIncomeGenerating)}
                    className={`w-full flex items-center justify-center gap-2 px-3 py-2 text-sm rounded-md transition-colors ${
                      task.isIncomeGenerating ? 'bg-yellow-400 text-yellow-900 hover:bg-yellow-500' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'
                    }`}
                    aria-pressed={task.isIncomeGenerating}
                  >
                    <DollarSignIcon className="w-4 h-4" />
                    <span>Income-Generating Activity</span>
                  </button>
                </div>
              )}
            </div>
            <div className="flex flex-col items-center gap-2">
              {onPromote && <button onClick={onPromote} title="Promote to Top 3" className="text-slate-500 hover:text-green-600"><ArrowUpCircleIcon className="w-6 h-6" /></button>}
              {onDemote && <button onClick={onDemote} title="Demote to Brain Dump" className="text-slate-500 hover:text-yellow-600"><ArrowDownCircleIcon className="w-6 h-6" /></button>}
              {onSendToVault && <button onClick={onSendToVault} title="Send to Ideas Vault" className="text-slate-500 hover:text-purple-600"><LightbulbIcon className="w-5 h-5" /></button>}
              {onLaunchGemini && <button onClick={onLaunchGemini} title="Work with Gemini" className="text-slate-500 hover:text-blue-600"><SparkleIcon className="w-5 h-5" /></button>}
              <button onClick={onDelete} title="Delete Task" className="text-slate-500 hover:text-red-600"><TrashIcon className="w-5 h-5" /></button>
            </div>
          </div>
        );
      };

      // Non-Negotiable Tasks Component
      const NonNegotiableTasks = ({ tasks, onUpdateTask }) => {
        const handleToggle = (task, field, value) => {
          onUpdateTask({ ...task, [field]: value });
        };

        const handleAddToCalendar = (task) => {
          if (!task.scheduledTime || task.scheduledTime.match(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/) === null) {
            alert("Please set a valid time for the task first.");
            return;
          }

          const [hours, minutes] = task.scheduledTime.split(':').map(Number);
          const startTime = new Date();
          startTime.setHours(hours, minutes, 0, 0);
          const durationMinutes = task.duration || 60;
          const endTime = new Date(startTime.getTime() + durationMinutes * 60 * 1000);

          const toGoogleFormat = (date) => {
            return date.toISOString().replace(/-|:|\.\d{3}/g, '');
          };

          const calendarUrl = new URL('https://www.google.com/calendar/render');
          calendarUrl.searchParams.append('action', 'TEMPLATE');
          calendarUrl.searchParams.append('text', task.text);
          calendarUrl.searchParams.append('dates', `${toGoogleFormat(startTime)}/${toGoogleFormat(endTime)}`);
          calendarUrl.searchParams.append('details', task.notes || `Completing task: ${task.text}`);
          calendarUrl.searchParams.append('crm', 'BUSY');

          window.open(calendarUrl.toString() + '&colorId=11', '_blank', 'noopener,noreferrer');
        };

        return (
          <div className="space-y-3">
            {tasks.map(task => (
              <div key={task.id} className="p-3 rounded-lg flex items-center gap-4 bg-slate-50 border border-slate-200">
                <input
                  type="checkbox"
                  checked={task.isCompleted}
                  onChange={(e) => handleToggle(task, 'isCompleted', e.target.checked)}
                  className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 shrink-0"
                  aria-label={`Mark task '${task.text}' as complete`}
                />
                <div className="flex-1">
                  <p className="font-medium text-slate-800">{task.text}</p>
                </div>
                <div className="flex items-center gap-2">
                  <input
                    type="time"
                    value={task.scheduledTime}
                    onChange={(e) => handleToggle(task, 'scheduledTime', e.target.value)}
                    className="block w-32 text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500 focus:border-blue-500"
                    aria-label="Scheduled time"
                  />
                  <button
                    onClick={() => handleAddToCalendar(task)}
                    title="Add to Google Calendar"
                    className="p-2 rounded-md bg-white border border-slate-300 text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled={!task.scheduledTime}
                    aria-label="Add to Google Calendar"
                  >
                    <CalendarIcon className="w-5 h-5" />
                  </button>
                </div>
              </div>
            ))}
          </div>
        );
      };

      // Simple LAPS Tracker Component
      const LapsTracker = ({ lapsHistory, setLapsHistory }) => {
        const todayStr = new Date().toISOString().split('T')[0];

        const todayData = useMemo(() => {
          return lapsHistory.find(d => d.date === todayStr) || { date: todayStr, leads: 0, appointments: 0, presentations: 0, sales: 0 };
        }, [lapsHistory, todayStr]);

        const [currentLaps, setCurrentLaps] = useState(todayData);
        const [saveStatus, setSaveStatus] = useState('idle');

        useEffect(() => {
          setCurrentLaps(todayData);
        }, [todayData]);

        const handleInputChange = (e) => {
          const { name, value } = e.target;
          setCurrentLaps(prev => ({ ...prev, [name]: Number(value) < 0 ? 0 : Number(value) }));
          setSaveStatus('idle');
        };

        const handleSave = () => {
          setSaveStatus('saving');
          setLapsHistory(prevHistory => {
            const existingIndex = prevHistory.findIndex(d => d.date === todayStr);
            if (existingIndex > -1) {
              const newHistory = [...prevHistory];
              newHistory[existingIndex] = { ...currentLaps, date: todayStr };
              return newHistory;
            } else {
              return [...prevHistory, { ...currentLaps, date: todayStr }];
            }
          });
          setTimeout(() => setSaveStatus('saved'), 300);
          setTimeout(() => setSaveStatus('idle'), 2500);
        };

        return (
          <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-2xl font-bold text-slate-800 mb-4">üìä LAPS Tracker</h2>
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-slate-700 mb-3">Today's Laps ({todayStr})</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                {['leads', 'appointments', 'presentations', 'sales'].map(key => (
                  <div key={key}>
                    <label htmlFor={key} className="block text-sm font-medium text-slate-600 capitalize">{key}</label>
                    <input
                      type="number"
                      name={key}
                      id={key}
                      value={currentLaps[key]}
                      onChange={handleInputChange}
                      className="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"
                      min="0"
                    />
                  </div>
                ))}
              </div>
              <button
                onClick={handleSave}
                className={`px-4 py-2 rounded-md font-medium transition-colors ${
                  saveStatus === 'saved' ? 'bg-green-500 text-white' :
                  saveStatus === 'saving' ? 'bg-blue-400 text-white' :
                  'bg-blue-500 text-white hover:bg-blue-600'
                }`}
                disabled={saveStatus === 'saving'}
              >
                {saveStatus === 'saved' ? '‚úì Saved!' : saveStatus === 'saving' ? 'Saving...' : 'Save Today\'s LAPS'}
              </button>
            </div>
          </div>
        );
      };

      // Main App Component
      const NON_NEGOTIABLE_TASKS_BASE = [
        { id: 'nn-prospecting', text: 'Prospecting Min 1 hr', isIncomeGenerating: true, duration: 60 },
        { id: 'nn-linkedin', text: 'Linkedin Post and commenting Min 1 hr', isIncomeGenerating: false, duration: 60 },
      ];

      const App = () => {
        const todayStr = new Date().toISOString().split('T')[0];
        const [brainDump, setBrainDump] = useLocalStorage('timeboxing-brainDump', []);
        const [topThree, setTopThree] = useLocalStorage(`timeboxing-topThree_${todayStr}`, []);
        const [completedHistory, setCompletedHistory] = useLocalStorage('timeboxing-completedHistory', []);
        const [ideasVault, setIdeasVault] = useLocalStorage('timeboxing-ideasVault', []);

        const [lapsHistory, setLapsHistory] = useLocalStorage('lapsHistory', []);
        const [accountabilityHistory, setAccountabilityHistory] = useLocalStorage('accountability-history', []);

        const [nonNegotiableTasks, setNonNegotiableTasks] = useLocalStorage(
          `timeboxing-nonNegotiable_${todayStr}`,
          NON_NEGOTIABLE_TASKS_BASE.map(task => ({
            ...task,
            isCompleted: false,
            scheduledTime: '',
            notes: '',
          }))
        );

        const [newTaskText, setNewTaskText] = useState('');
        const [showCompleted, setShowCompleted] = useState(false);
        const [showIdeasVault, setShowIdeasVault] = useState(false);

        const handleAddTask = (e) => {
          e.preventDefault();
          if (newTaskText.trim() === '') return;
          const newTask = {
            id: generateUUID(),
            text: newTaskText,
            isCompleted: false,
            isIncomeGenerating: false,
            notes: '',
            scheduledTime: '',
            duration: 60,
          };
          setBrainDump(prev => [newTask, ...prev]);
          setNewTaskText('');
        };

        const handleUpdateTask = useCallback((updatedTask) => {
          if (updatedTask.isCompleted) {
            const taskToArchive = { ...updatedTask, completedAt: new Date().toISOString() };
            setCompletedHistory(prev => [taskToArchive, ...prev]);
            setBrainDump(prev => prev.filter(t => t.id !== updatedTask.id));
            setTopThree(prev => prev.filter(t => t.id !== updatedTask.id));
          } else {
            setBrainDump(prev => prev.map(t => t.id === updatedTask.id ? updatedTask : t));
            setTopThree(prev => prev.map(t => t.id === updatedTask.id ? updatedTask : t));
          }
        }, [setBrainDump, setTopThree, setCompletedHistory]);

        const handleUpdateNonNegotiableTask = useCallback((updatedTask) => {
          setNonNegotiableTasks(prev => prev.map(t => t.id === updatedTask.id ? updatedTask : t));
        }, [setNonNegotiableTasks]);

        const handleDeleteTask = (id, listSetter) => {
          if (window.confirm("Are you sure you want to permanently delete this item?")) {
            listSetter(prev => prev.filter(t => t.id !== id));
          }
        };

        const promoteTask = (id) => {
          if (topThree.length >= 3) {
            alert("You can only have 3 top tasks. Demote one first.");
            return;
          }
          const taskToPromote = brainDump.find(t => t.id === id);
          if (taskToPromote) {
            setTopThree(prev => [...prev, taskToPromote]);
            setBrainDump(prev => prev.filter(t => t.id !== id));
          }
        };

        const demoteTask = (id) => {
          const taskToDemote = topThree.find(t => t.id === id);
          if (taskToDemote) {
            setBrainDump(prev => [taskToDemote, ...prev]);
            setTopThree(prev => prev.filter(t => t.id !== id));
          }
        };

        const restoreTask = (id) => {
          const taskToRestore = completedHistory.find(t => t.id === id);
          if (taskToRestore) {
            const restoredTask = { ...taskToRestore, isCompleted: false, completedAt: undefined };
            setBrainDump(prev => [restoredTask, ...prev]);
            setCompletedHistory(prev => prev.filter(t => t.id !== id));
          }
        };

        const handleSendToVault = (id) => {
          const taskToVault = brainDump.find(t => t.id === id);
          if (taskToVault) {
            setIdeasVault(prev => [taskToVault, ...prev]);
            setBrainDump(prev => prev.filter(t => t.id !== id));
          }
        };

        const handleCopyFromVault = (id) => {
          const taskToCopy = ideasVault.find(t => t.id === id);
          if (taskToCopy) {
            const newActionableTask = { ...taskToCopy, id: generateUUID() };
            setBrainDump(prev => [newActionableTask, ...prev]);
            alert(`Copied "${taskToCopy.text}" to Brain Dump.`);
          }
        };

        const startNewDay = () => {
          if (window.confirm("Are you sure you want to end the day? Incomplete priorities will be returned to your Brain Dump.")) {
            const incompleteTasks = topThree.filter(t => !t.isCompleted);
            const tasksToDemote = incompleteTasks.map(t => ({...t, scheduledTime: '', notes: ''}));
            setBrainDump(prev => [...prev, ...tasksToDemote]);
            window.location.reload();
          }
        };

        const dayOfWeek = new Date().getDay(); // 0 = Sun, 6 = Sat
        const isWeekday = dayOfWeek > 0 && dayOfWeek < 6;

        return (
          <div className="min-h-screen bg-slate-100">
            <header className="bg-white shadow-sm sticky top-0 z-20">
              <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <h1 className="text-2xl font-bold text-slate-800">Momentum Tracker</h1>
                </div>
                <button
                  onClick={startNewDay}
                  className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                >
                  Start New Day
                </button>
              </div>
            </header>
            <main className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
              <Instructions />

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div className="flex flex-col gap-8">
                  <section aria-labelledby="top-3-heading" className="bg-white p-6 rounded-lg shadow-md">
                    <h2 id="top-3-heading" className="text-2xl font-bold text-slate-800 mb-4">‚≠ê Top 3 Priorities</h2>
                    <div className="space-y-4">
                      {topThree.length > 0 ? (
                        topThree.map(task => (
                          <TaskCard
                            key={task.id}
                            task={task}
                            onUpdate={handleUpdateTask}
                            onDelete={() => handleDeleteTask(task.id, setTopThree)}
                            onDemote={() => demoteTask(task.id)}
                            isTopThree={true}
                          />
                        ))
                      ) : (
                        <p className="text-slate-500 text-center py-4">Promote tasks from your brain dump to focus on them.</p>
                      )}
                      {topThree.length < 3 && Array.from({ length: 3 - topThree.length }).map((_, i) => (
                        <div key={i} className="p-4 rounded-lg border-2 border-dashed border-slate-300 text-center text-slate-400" aria-hidden="true">
                          Empty Priority Slot
                        </div>
                      ))}
                    </div>
                  </section>

                  {isWeekday && (
                    <section aria-labelledby="non-negotiable-heading" className="bg-white p-6 rounded-lg shadow-md">
                      <h2 id="non-negotiable-heading" className="text-2xl font-bold text-slate-800 mb-4">üóìÔ∏è Daily Non-Negotiables</h2>
                      <NonNegotiableTasks
                        tasks={nonNegotiableTasks}
                        onUpdateTask={handleUpdateNonNegotiableTask}
                      />
                    </section>
                  )}
                </div>

                <section aria-labelledby="brain-dump-heading" className="bg-white p-6 rounded-lg shadow-md">
                  <h2 id="brain-dump-heading" className="text-2xl font-bold text-slate-800 mb-4">üß† Brain Dump</h2>
                  <form onSubmit={handleAddTask} className="flex gap-2 mb-4">
                    <input
                      type="text"
                      value={newTaskText}
                      onChange={(e) => setNewTaskText(e.target.value)}
                      placeholder="Add a new task..."
                      className="flex-grow block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"
                      aria-label="New task input"
                    />
                    <button type="submit" aria-label="Add new task" className="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 flex items-center justify-center">
                      <PlusIcon className="w-5 h-5" />
                    </button>
                  </form>
                  <div className="space-y-3 max-h-[45rem] overflow-y-auto pr-2">
                    {brainDump.length > 0 ? (
                      brainDump.map(task => (
                        <TaskCard
                          key={task.id}
                          task={task}
                          onUpdate={handleUpdateTask}
                          onDelete={() => handleDeleteTask(task.id, setBrainDump)}
                          onPromote={() => promoteTask(task.id)}
                          onSendToVault={() => handleSendToVault(task.id)}
                          isTopThree={false}
                        />
                      ))
                    ) : (
                      <p className="text-slate-500 text-center py-4">Brain dump all your tasks for the day here.</p>
                    )}
                  </div>
                </section>
              </div>

              <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                <button
                  onClick={() => setShowIdeasVault(!showIdeasVault)}
                  className="w-full flex justify-between items-center text-left text-xl font-bold text-slate-800 focus:outline-none"
                >
                  <span>üí° Ideas Vault ({ideasVault.length})</span>
                  <ChevronDownIcon className={`w-6 h-6 transform transition-transform ${showIdeasVault ? 'rotate-180' : ''}`} />
                </button>
                {showIdeasVault && (
                  <div className="mt-4 pt-4 border-t">
                    {ideasVault.length > 0 ? (
                      <div className="space-y-3">
                        {ideasVault.map((task, index) => (
                          <div key={task.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                            <p className="text-slate-700">{task.text}</p>
                            <div className="flex items-center gap-2">
                              <button onClick={() => handleCopyFromVault(task.id)} title="Copy to Brain Dump" className="p-1 text-blue-600 hover:text-blue-800">
                                <RestoreIcon className="w-5 h-5" />
                              </button>
                              <button onClick={() => handleDeleteTask(task.id, setIdeasVault)} title="Delete Idea Permanently" className="p-1 text-red-600 hover:text-red-800">
                                <TrashIcon className="w-5 h-5" />
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-slate-500 text-center py-4">Send ideas here to review later.</p>
                    )}
                  </div>
                )}
              </div>

              <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                <button
                  onClick={() => setShowCompleted(!showCompleted)}
                  className="w-full flex justify-between items-center text-left text-xl font-bold text-slate-800 focus:outline-none"
                >
                  <span>‚úÖ Completed Task History ({completedHistory.length})</span>
                  <ChevronDownIcon className={`w-6 h-6 transform transition-transform ${showCompleted ? 'rotate-180' : ''}`} />
                </button>
                {showCompleted && completedHistory.length > 0 && (
                  <div className="mt-4 overflow-x-auto rounded-lg border border-slate-200">
                    <table className="min-w-full divide-y divide-slate-200">
                      <thead className="bg-slate-50">
                        <tr>
                          <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Task</th>
                          <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Completed At</th>
                          <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-slate-200">
                        {completedHistory.map(task => (
                          <tr key={task.id}>
                            <td className="px-6 py-4 whitespace-normal text-sm font-medium text-slate-900">{task.text}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{new Date(task.completedAt).toLocaleString()}</td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                              <div className="flex items-center gap-4">
                                <button onClick={() => restoreTask(task.id)} title="Restore Task" className="text-blue-600 hover:text-blue-800 flex items-center gap-1">
                                  <RestoreIcon className="w-4 h-4" />
                                  <span>Restore</span>
                                </button>
                                <button onClick={() => handleDeleteTask(task.id, setCompletedHistory)} title="Delete Task Permanently" className="text-red-600 hover:text-red-800 flex items-center gap-1">
                                  <TrashIcon className="w-4 h-4" />
                                  <span>Delete</span>
                                </button>
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
                {showCompleted && completedHistory.length === 0 && (
                  <p className="mt-4 text-slate-500 text-center py-4">No completed tasks yet. Get to work!</p>
                )}
              </div>

              <div className="mb-8">
                <LapsTracker lapsHistory={lapsHistory} setLapsHistory={setLapsHistory} />
              </div>

            </main>
          </div>
        );
      };

      // Render the app
      const rootElement = document.getElementById('root');
      if (rootElement) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
      } else {
        console.error('Root element not found');
      }
    </script>
  </body>
</html>
