<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Momentum Tracker - Personal Productivity System</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM from CDN (UMD builds) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <!-- The root element for the React app -->
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useCallback, useEffect, useMemo, useRef } = React;

      // UUID generation with fallback for older browsers
      const generateUUID = () => {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) {
          return crypto.randomUUID();
        }
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0;
          const v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      };

      // User Management System
      const UserManager = {
        getCurrentUser: () => {
          const userData = localStorage.getItem('momentum-current-user');
          return userData ? JSON.parse(userData) : null;
        },
        
        setCurrentUser: (user) => {
          localStorage.setItem('momentum-current-user', JSON.stringify(user));
        },
        
        createUser: (profile) => {
          const user = {
            id: generateUUID(),
            ...profile,
            createdAt: new Date().toISOString(),
            settings: {
              nonNegotiables: profile.nonNegotiables || [],
              calendarProvider: profile.calendarProvider || 'google',
              aiProvider: profile.aiProvider || 'none',
              aiApiKey: profile.aiApiKey || null,
              ...profile.settings
            }
          };
          
          // Save user profile
          const users = JSON.parse(localStorage.getItem('momentum-users') || '[]');
          users.push(user);
          localStorage.setItem('momentum-users', JSON.stringify(users));
          
          return user;
        },
        
        getDataKey: (userId, dataType) => `momentum-${userId}-${dataType}`,
        
        getUserData: (userId, dataType, defaultValue = []) => {
          const key = UserManager.getDataKey(userId, dataType);
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : defaultValue;
        },
        
        setUserData: (userId, dataType, data) => {
          const key = UserManager.getDataKey(userId, dataType);
          localStorage.setItem(key, JSON.stringify(data));
        }
      };

      // Multi-User LocalStorage Hook
      const useUserLocalStorage = (dataType, initialValue) => {
        const currentUser = UserManager.getCurrentUser();
        const userId = currentUser?.id;
        
        const [storedValue, setStoredValue] = useState(() => {
          if (!userId) return initialValue;
          return UserManager.getUserData(userId, dataType, initialValue);
        });

        const setValue = (value) => {
          if (!userId) return;
          
          const valueToStore = value instanceof Function ? value(storedValue) : value;
          setStoredValue(valueToStore);
          UserManager.setUserData(userId, dataType, valueToStore);
        };

        return [storedValue, setValue];
      };

      // Pre-defined Non-Negotiable Templates
      const NON_NEGOTIABLE_TEMPLATES = [
        { category: "Health & Fitness", tasks: [
          { text: "Morning workout (30 mins)", duration: 30 },
          { text: "Evening walk", duration: 20 },
          { text: "Meditation", duration: 15 },
          { text: "Drink 8 glasses of water", duration: 5 }
        ]},
        { category: "Business & Career", tasks: [
          { text: "Prospecting (1 hour)", duration: 60 },
          { text: "LinkedIn engagement", duration: 30 },
          { text: "Skill development", duration: 45 },
          { text: "Industry reading", duration: 20 }
        ]},
        { category: "Personal Development", tasks: [
          { text: "Read for 30 minutes", duration: 30 },
          { text: "Journal writing", duration: 15 },
          { text: "Plan tomorrow", duration: 10 },
          { text: "Gratitude practice", duration: 5 }
        ]},
        { category: "Family & Relationships", tasks: [
          { text: "Quality time with family", duration: 60 },
          { text: "Call a friend", duration: 15 },
          { text: "Date night planning", duration: 10 },
          { text: "Check in with parents", duration: 10 }
        ]}
      ];

      // Setup Wizard Component
      const SetupWizard = ({ onComplete }) => {
        const [step, setStep] = useState(1);
        const [profile, setProfile] = useState({
          name: '',
          email: '',
          nonNegotiables: [],
          calendarProvider: 'google',
          aiProvider: 'none',
          aiApiKey: ''
        });

        const handleNext = () => setStep(step + 1);
        const handleBack = () => setStep(step - 1);

        const handleComplete = () => {
          const user = UserManager.createUser(profile);
          UserManager.setCurrentUser(user);
          onComplete(user);
        };

        const addNonNegotiable = (task) => {
          if (profile.nonNegotiables.length < 3) {
            setProfile(prev => ({
              ...prev,
              nonNegotiables: [...prev.nonNegotiables, { ...task, id: generateUUID() }]
            }));
          }
        };

        const removeNonNegotiable = (id) => {
          setProfile(prev => ({
            ...prev,
            nonNegotiables: prev.nonNegotiables.filter(task => task.id !== id)
          }));
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8">
              
              {/* Progress Bar */}
              <div className="mb-8">
                <div className="flex justify-between text-sm text-gray-500 mb-2">
                  <span>Step {step} of 4</span>
                  <span>{Math.round((step / 4) * 100)}% Complete</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                    style={{ width: `${(step / 4) * 100}%` }}
                  ></div>
                </div>
              </div>

              {/* Step 1: Personal Info */}
              {step === 1 && (
                <div>
                  <h2 className="text-3xl font-bold text-gray-800 mb-2">Welcome to Momentum Tracker!</h2>
                  <p className="text-gray-600 mb-6">Let's set up your personal productivity system.</p>
                  
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                      <input
                        type="text"
                        value={profile.name}
                        onChange={(e) => setProfile(prev => ({ ...prev, name: e.target.value }))}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Enter your full name"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Email (Optional)</label>
                      <input
                        type="email"
                        value={profile.email}
                        onChange={(e) => setProfile(prev => ({ ...prev, email: e.target.value }))}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="your@email.com"
                      />
                    </div>
                  </div>
                  
                  <div className="flex justify-end mt-8">
                    <button
                      onClick={handleNext}
                      disabled={!profile.name.trim()}
                      className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Next ‚Üí
                    </button>
                  </div>
                </div>
              )}

              {/* Step 2: Non-Negotiables */}
              {step === 2 && (
                <div>
                  <h2 className="text-2xl font-bold text-gray-800 mb-2">Choose Your Daily Non-Negotiables</h2>
                  <p className="text-gray-600 mb-6">Select up to 3 tasks you want to do every weekday. These will appear in your tracker automatically.</p>
                  
                  <div className="mb-6">
                    <h3 className="font-semibold text-gray-700 mb-2">Selected ({profile.nonNegotiables.length}/3):</h3>
                    <div className="space-y-2">
                      {profile.nonNegotiables.map(task => (
                        <div key={task.id} className="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                          <span className="font-medium">{task.text}</span>
                          <button
                            onClick={() => removeNonNegotiable(task.id)}
                            className="text-red-500 hover:text-red-700"
                          >
                            Remove
                          </button>
                        </div>
                      ))}
                      {profile.nonNegotiables.length === 0 && (
                        <p className="text-gray-500 italic">No tasks selected yet</p>
                      )}
                    </div>
                  </div>

                  <div className="space-y-4">
                    {NON_NEGOTIABLE_TEMPLATES.map(category => (
                      <div key={category.category}>
                        <h4 className="font-semibold text-gray-700 mb-2">{category.category}</h4>
                        <div className="grid grid-cols-1 gap-2">
                          {category.tasks.map((task, index) => (
                            <button
                              key={index}
                              onClick={() => addNonNegotiable(task)}
                              disabled={profile.nonNegotiables.length >= 3}
                              className="text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                              <div className="font-medium">{task.text}</div>
                              <div className="text-sm text-gray-500">{task.duration} minutes</div>
                            </button>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                  
                  <div className="flex justify-between mt-8">
                    <button
                      onClick={handleBack}
                      className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                    >
                      ‚Üê Back
                    </button>
                    <button
                      onClick={handleNext}
                      className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      Next ‚Üí
                    </button>
                  </div>
                </div>
              )}

              {/* Step 3: Calendar Integration */}
              {step === 3 && (
                <div>
                  <h2 className="text-2xl font-bold text-gray-800 mb-2">Calendar Integration</h2>
                  <p className="text-gray-600 mb-6">Choose your preferred calendar for scheduling tasks.</p>

                  <div className="space-y-3">
                    {[
                      { id: 'google', name: 'Google Calendar', icon: 'üìÖ', description: 'Most popular choice' },
                      { id: 'outlook', name: 'Microsoft Outlook', icon: 'üìÜ', description: 'Great for business users' },
                      { id: 'apple', name: 'Apple Calendar', icon: 'üçé', description: 'Perfect for Mac/iPhone users' },
                      { id: 'other', name: 'Other/Manual', icon: 'üìù', description: 'I\'ll add events manually' }
                    ].map(option => (
                      <label key={option.id} className="flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input
                          type="radio"
                          name="calendar"
                          value={option.id}
                          checked={profile.calendarProvider === option.id}
                          onChange={(e) => setProfile(prev => ({ ...prev, calendarProvider: e.target.value }))}
                          className="mr-4"
                        />
                        <div className="flex-1">
                          <div className="flex items-center">
                            <span className="text-2xl mr-3">{option.icon}</span>
                            <div>
                              <div className="font-semibold">{option.name}</div>
                              <div className="text-sm text-gray-500">{option.description}</div>
                            </div>
                          </div>
                        </div>
                      </label>
                    ))}
                  </div>

                  <div className="flex justify-between mt-8">
                    <button
                      onClick={handleBack}
                      className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                    >
                      ‚Üê Back
                    </button>
                    <button
                      onClick={handleNext}
                      className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      Next ‚Üí
                    </button>
                  </div>
                </div>
              )}

              {/* Step 4: AI Assistant */}
              {step === 4 && (
                <div>
                  <h2 className="text-2xl font-bold text-gray-800 mb-2">AI Assistant (Optional)</h2>
                  <p className="text-gray-600 mb-6">Choose an AI assistant to help with task planning and brainstorming.</p>

                  <div className="space-y-3 mb-6">
                    {[
                      { id: 'none', name: 'No AI Assistant', icon: 'üö´', description: 'I prefer to work without AI help' },
                      { id: 'openai', name: 'ChatGPT (OpenAI)', icon: 'ü§ñ', description: 'Requires your OpenAI API key' },
                      { id: 'gemini', name: 'Google Gemini', icon: '‚ú®', description: 'Requires your Google AI API key' }
                    ].map(option => (
                      <label key={option.id} className="flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input
                          type="radio"
                          name="ai"
                          value={option.id}
                          checked={profile.aiProvider === option.id}
                          onChange={(e) => setProfile(prev => ({ ...prev, aiProvider: e.target.value }))}
                          className="mr-4"
                        />
                        <div className="flex-1">
                          <div className="flex items-center">
                            <span className="text-2xl mr-3">{option.icon}</span>
                            <div>
                              <div className="font-semibold">{option.name}</div>
                              <div className="text-sm text-gray-500">{option.description}</div>
                            </div>
                          </div>
                        </div>
                      </label>
                    ))}
                  </div>

                  {profile.aiProvider !== 'none' && (
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                      <h4 className="font-semibold text-yellow-800 mb-2">API Key Required</h4>
                      <p className="text-sm text-yellow-700 mb-3">
                        You'll need your own API key for {profile.aiProvider === 'openai' ? 'OpenAI' : 'Google AI'}.
                        This keeps your usage private and under your control.
                      </p>
                      <input
                        type="password"
                        value={profile.aiApiKey}
                        onChange={(e) => setProfile(prev => ({ ...prev, aiApiKey: e.target.value }))}
                        placeholder={`Enter your ${profile.aiProvider === 'openai' ? 'OpenAI' : 'Google AI'} API key`}
                        className="w-full p-3 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"
                      />
                      <p className="text-xs text-yellow-600 mt-2">
                        Your API key is stored locally and never shared. You can change this later in settings.
                      </p>
                    </div>
                  )}

                  <div className="flex justify-between mt-8">
                    <button
                      onClick={handleBack}
                      className="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                    >
                      ‚Üê Back
                    </button>
                    <button
                      onClick={handleComplete}
                      className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
                    >
                      Complete Setup üéâ
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      };

      // Icon Components (same as before)
      const PlusIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      );

      const TrashIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      );

      const ArrowUpCircleIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="16 12 12 8 8 12"></polyline>
          <line x1="12" y1="16" x2="12" y2="8"></line>
        </svg>
      );

      const ArrowDownCircleIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="8 12 12 16 16 12"></polyline>
          <line x1="12" y1="8" x2="12" y2="16"></line>
        </svg>
      );

      const ChevronDownIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      );

      const DollarSignIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <line x1="12" y1="1" x2="12" y2="23"></line>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
      );

      const CalendarIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      );

      const SparkleIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M12 2L9.1 8.26 3 9.27l4.55 4.34L6.2 20 12 16.54 17.8 20l-1.35-6.39L21 9.27l-6.1-1.01L12 2z"></path>
          <path d="M5 3v4"></path>
          <path d="M19 17v4"></path>
          <path d="M3 5h4"></path>
          <path d="M17 19h4"></path>
        </svg>
      );

      const SettingsIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m11-7a4 4 0 0 1 0 8 4 4 0 0 1 0-8z"></path>
        </svg>
      );

      // Calendar Integration Helper
      const getCalendarUrl = (task, calendarProvider) => {
        if (!task.scheduledTime) return null;

        const [hours, minutes] = task.scheduledTime.split(':').map(Number);
        const startTime = new Date();
        startTime.setHours(hours, minutes, 0, 0);
        const durationMinutes = task.duration || 60;
        const endTime = new Date(startTime.getTime() + durationMinutes * 60 * 1000);

        const toGoogleFormat = (date) => date.toISOString().replace(/-|:|\.\d{3}/g, '');

        switch (calendarProvider) {
          case 'google':
            const googleUrl = new URL('https://www.google.com/calendar/render');
            googleUrl.searchParams.append('action', 'TEMPLATE');
            googleUrl.searchParams.append('text', task.text);
            googleUrl.searchParams.append('dates', `${toGoogleFormat(startTime)}/${toGoogleFormat(endTime)}`);
            googleUrl.searchParams.append('details', task.notes || `Completing task: ${task.text}`);
            return googleUrl.toString();

          case 'outlook':
            const outlookUrl = new URL('https://outlook.live.com/calendar/0/deeplink/compose');
            outlookUrl.searchParams.append('subject', task.text);
            outlookUrl.searchParams.append('startdt', startTime.toISOString());
            outlookUrl.searchParams.append('enddt', endTime.toISOString());
            outlookUrl.searchParams.append('body', task.notes || `Completing task: ${task.text}`);
            return outlookUrl.toString();

          case 'apple':
            // Apple Calendar uses webcal:// protocol, but we'll provide instructions
            return `data:text/calendar;charset=utf8,BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART:${toGoogleFormat(startTime)}
DTEND:${toGoogleFormat(endTime)}
SUMMARY:${task.text}
DESCRIPTION:${task.notes || `Completing task: ${task.text}`}
END:VEVENT
END:VCALENDAR`;

          default:
            return null;
        }
      };

      // AI Integration Helper
      const callAI = async (task, prompt, user) => {
        if (user.settings.aiProvider === 'none') {
          throw new Error('AI assistant is disabled in your settings');
        }

        if (!user.settings.aiApiKey) {
          throw new Error('Please add your API key in settings to use AI features');
        }

        const contextualPrompt = `
You are an AI assistant helping with productivity and business tasks.

TASK CONTEXT:
- Task: "${task.text}"
- Notes: "${task.notes || 'No additional notes'}"
- Income-Generating Activity: ${task.isIncomeGenerating ? 'Yes' : 'No'}

USER REQUEST:
${prompt}

Please provide helpful, actionable advice related to this specific task. Be concise but thorough.
`;

        if (user.settings.aiProvider === 'openai') {
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${user.settings.aiApiKey}`
            },
            body: JSON.stringify({
              model: 'gpt-3.5-turbo',
              messages: [{ role: 'user', content: contextualPrompt }],
              max_tokens: 500,
              temperature: 0.7
            })
          });

          if (!response.ok) {
            throw new Error('Failed to get response from ChatGPT');
          }

          const data = await response.json();
          return data.choices[0].message.content;

        } else if (user.settings.aiProvider === 'gemini') {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${user.settings.aiApiKey}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ parts: [{ text: contextualPrompt }] }],
                generationConfig: { temperature: 0.7, maxOutputTokens: 500 }
              })
            }
          );

          if (!response.ok) {
            throw new Error('Failed to get response from Gemini');
          }

          const data = await response.json();
          return data.candidates[0].content.parts[0].text;
        }
      };

      // AI Modal Component
      const AIModal = ({ task, user, onClose }) => {
        const [prompt, setPrompt] = useState('');
        const [response, setResponse] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState('');

        const handleSubmit = async (e) => {
          e.preventDefault();
          if (!prompt.trim() || isLoading) return;

          setIsLoading(true);
          setError('');
          setResponse('');

          try {
            const aiResponse = await callAI(task, prompt, user);
            setResponse(aiResponse);
          } catch (err) {
            setError(err.message);
          } finally {
            setIsLoading(false);
          }
        };

        if (user.settings.aiProvider === 'none') {
          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
                <h2 className="text-lg font-semibold text-slate-800 mb-4">AI Assistant Disabled</h2>
                <p className="text-slate-600 mb-4">
                  You chose not to use an AI assistant during setup. You can enable this feature in your settings.
                </p>
                <button
                  onClick={onClose}
                  className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                  Close
                </button>
              </div>
            </div>
          );
        }

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl h-[80vh] flex flex-col">
              <header className="flex items-center justify-between p-4 border-b">
                <div>
                  <h2 className="text-lg font-semibold text-slate-800">
                    {user.settings.aiProvider === 'openai' ? 'ü§ñ ChatGPT' : '‚ú® Gemini'} Assistant
                  </h2>
                  <p className="text-sm text-slate-500">Working on: {task.text}</p>
                </div>
                <button onClick={onClose} className="text-slate-400 hover:text-slate-600">‚úï</button>
              </header>

              <main className="flex-1 p-6 overflow-y-auto">
                {response && (
                  <div className="bg-slate-50 p-4 rounded-lg mb-4">
                    <pre className="whitespace-pre-wrap font-sans text-slate-800">{response}</pre>
                  </div>
                )}
                {error && (
                  <div className="bg-red-50 border border-red-200 p-4 rounded-lg mb-4">
                    <p className="text-red-800">{error}</p>
                  </div>
                )}
                {isLoading && (
                  <div className="text-center py-8">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                    <p className="text-slate-600 mt-2">Thinking...</p>
                  </div>
                )}
              </main>

              <footer className="p-4 border-t">
                <form onSubmit={handleSubmit} className="flex gap-3">
                  <input
                    type="text"
                    value={prompt}
                    onChange={(e) => setPrompt(e.target.value)}
                    placeholder="Ask for help with this task..."
                    className="flex-1 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    disabled={isLoading}
                  />
                  <button
                    type="submit"
                    disabled={!prompt.trim() || isLoading}
                    className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                  >
                    Ask AI
                  </button>
                </form>
              </footer>
            </div>
          </div>
        );
      };

      // Task Card Component
      const TaskCard = ({ task, onUpdate, onDelete, onPromote, onDemote, onLaunchAI, isTopThree, user }) => {
        const handleToggle = (field, value) => {
          onUpdate({ ...task, [field]: value });
        };

        const handleAddToCalendar = () => {
          if (!task.scheduledTime) {
            alert("Please set a valid time for the task first.");
            return;
          }

          const calendarUrl = getCalendarUrl(task, user.settings.calendarProvider);
          if (calendarUrl) {
            if (user.settings.calendarProvider === 'apple') {
              // For Apple Calendar, download the .ics file
              const link = document.createElement('a');
              link.href = calendarUrl;
              link.download = `${task.text.replace(/[^a-z0-9]/gi, '_')}.ics`;
              link.click();
            } else {
              window.open(calendarUrl, '_blank', 'noopener,noreferrer');
            }
          } else {
            alert("Calendar integration not available for your selected provider.");
          }
        };

        return (
          <div className="p-4 rounded-lg flex items-start gap-4 bg-white border border-slate-200">
            <input
              type="checkbox"
              checked={task.isCompleted}
              onChange={(e) => handleToggle('isCompleted', e.target.checked)}
              className="mt-1 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            />
            <div className="flex-1">
              <p className="font-medium text-slate-800">{task.text}</p>
              {isTopThree && (
                <div className="mt-3 space-y-3">
                  <div className="grid grid-cols-2 gap-2">
                    <input
                      type="time"
                      value={task.scheduledTime || ''}
                      onChange={(e) => handleToggle('scheduledTime', e.target.value)}
                      className="block w-full text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500"
                    />
                    <select
                      value={task.duration || 60}
                      onChange={(e) => handleToggle('duration', Number(e.target.value))}
                      className="block w-full text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500"
                    >
                      <option value="15">15 mins</option>
                      <option value="30">30 mins</option>
                      <option value="45">45 mins</option>
                      <option value="60">1 hour</option>
                      <option value="90">1.5 hours</option>
                      <option value="120">2 hours</option>
                    </select>
                  </div>
                  <button
                    onClick={handleAddToCalendar}
                    className="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-white border border-slate-300 text-slate-600 hover:bg-slate-50"
                  >
                    <CalendarIcon className="w-5 h-5" />
                    Add to {user.settings.calendarProvider === 'google' ? 'Google' : user.settings.calendarProvider === 'outlook' ? 'Outlook' : user.settings.calendarProvider === 'apple' ? 'Apple' : ''} Calendar
                  </button>
                  <textarea
                    placeholder="Action points & notes..."
                    value={task.notes || ''}
                    onChange={(e) => handleToggle('notes', e.target.value)}
                    rows={3}
                    className="block w-full text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500"
                  />
                  <button
                    onClick={() => handleToggle('isIncomeGenerating', !task.isIncomeGenerating)}
                    className={`w-full flex items-center justify-center gap-2 px-3 py-2 text-sm rounded-md transition-colors ${
                      task.isIncomeGenerating ? 'bg-yellow-400 text-yellow-900 hover:bg-yellow-500' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'
                    }`}
                  >
                    <DollarSignIcon className="w-4 h-4" />
                    Income-Generating Activity
                  </button>
                </div>
              )}
            </div>
            <div className="flex flex-col items-center gap-2">
              {onPromote && <button onClick={onPromote} title="Promote to Top 3" className="text-slate-500 hover:text-green-600"><ArrowUpCircleIcon className="w-6 h-6" /></button>}
              {onDemote && <button onClick={onDemote} title="Demote to Brain Dump" className="text-slate-500 hover:text-yellow-600"><ArrowDownCircleIcon className="w-6 h-6" /></button>}
              {user.settings.aiProvider !== 'none' && onLaunchAI && <button onClick={onLaunchAI} title="Ask AI Assistant" className="text-slate-500 hover:text-blue-600"><SparkleIcon className="w-5 h-5" /></button>}
              <button onClick={onDelete} title="Delete Task" className="text-slate-500 hover:text-red-600"><TrashIcon className="w-5 h-5" /></button>
            </div>
          </div>
        );
      };

      // Main Momentum Tracker App
      const MomentumApp = ({ user }) => {
        const todayStr = new Date().toISOString().split('T')[0];

        // User-specific data with isolated storage
        const [brainDump, setBrainDump] = useUserLocalStorage('brainDump', []);
        const [topThree, setTopThree] = useUserLocalStorage(`topThree_${todayStr}`, []);
        const [completedHistory, setCompletedHistory] = useUserLocalStorage('completedHistory', []);
        const [lapsHistory, setLapsHistory] = useUserLocalStorage('lapsHistory', []);

        // User's personalized non-negotiables
        const [nonNegotiableTasks, setNonNegotiableTasks] = useUserLocalStorage(
          `nonNegotiable_${todayStr}`,
          user.settings.nonNegotiables.map(task => ({
            ...task,
            isCompleted: false,
            scheduledTime: '',
            notes: '',
          }))
        );

        const [newTaskText, setNewTaskText] = useState('');
        const [showCompleted, setShowCompleted] = useState(false);
        const [aiTask, setAiTask] = useState(null);
        const [showSettings, setShowSettings] = useState(false);

        const handleAddTask = (e) => {
          e.preventDefault();
          if (newTaskText.trim() === '') return;
          const newTask = {
            id: generateUUID(),
            text: newTaskText,
            isCompleted: false,
            isIncomeGenerating: false,
            notes: '',
            scheduledTime: '',
            duration: 60,
          };
          setBrainDump(prev => [newTask, ...prev]);
          setNewTaskText('');
        };

        const handleUpdateTask = useCallback((updatedTask) => {
          if (updatedTask.isCompleted) {
            const taskToArchive = { ...updatedTask, completedAt: new Date().toISOString() };
            setCompletedHistory(prev => [taskToArchive, ...prev]);
            setBrainDump(prev => prev.filter(t => t.id !== updatedTask.id));
            setTopThree(prev => prev.filter(t => t.id !== updatedTask.id));
          } else {
            setBrainDump(prev => prev.map(t => t.id === updatedTask.id ? updatedTask : t));
            setTopThree(prev => prev.map(t => t.id === updatedTask.id ? updatedTask : t));
          }
        }, [setBrainDump, setTopThree, setCompletedHistory]);

        const handleUpdateNonNegotiableTask = useCallback((updatedTask) => {
          setNonNegotiableTasks(prev => prev.map(t => t.id === updatedTask.id ? updatedTask : t));
        }, [setNonNegotiableTasks]);

        const handleDeleteTask = (id, listSetter) => {
          if (window.confirm("Are you sure you want to permanently delete this item?")) {
            listSetter(prev => prev.filter(t => t.id !== id));
          }
        };

        const promoteTask = (id) => {
          if (topThree.length >= 3) {
            alert("You can only have 3 top tasks. Demote one first.");
            return;
          }
          const taskToPromote = brainDump.find(t => t.id === id);
          if (taskToPromote) {
            setTopThree(prev => [...prev, taskToPromote]);
            setBrainDump(prev => prev.filter(t => t.id !== id));
          }
        };

        const demoteTask = (id) => {
          const taskToDemote = topThree.find(t => t.id === id);
          if (taskToDemote) {
            setBrainDump(prev => [taskToDemote, ...prev]);
            setTopThree(prev => prev.filter(t => t.id !== id));
          }
        };

        const startNewDay = () => {
          if (window.confirm("Are you sure you want to end the day? Incomplete priorities will be returned to your Brain Dump.")) {
            const incompleteTasks = topThree.filter(t => !t.isCompleted);
            if (incompleteTasks.length > 0) {
              const tasksToDemote = incompleteTasks.map(t => ({
                ...t,
                scheduledTime: '',
                notes: '',
                isIncomeGenerating: false
              }));
              setBrainDump(prev => [...tasksToDemote, ...prev]);
            }
            setTopThree([]);
            setTimeout(() => window.location.reload(), 100);
          }
        };

        const dayOfWeek = new Date().getDay();
        const isWeekday = dayOfWeek > 0 && dayOfWeek < 6;

        return (
          <div className="min-h-screen bg-slate-100">
            <header className="bg-white shadow-sm sticky top-0 z-20">
              <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div>
                  <h1 className="text-2xl font-bold text-slate-800">Momentum Tracker</h1>
                  <p className="text-sm text-slate-600">Welcome back, {user.name}!</p>
                </div>
                <div className="flex items-center gap-3">
                  <button
                    onClick={() => setShowSettings(true)}
                    className="p-2 text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-lg"
                    title="Settings"
                  >
                    <SettingsIcon className="w-5 h-5" />
                  </button>
                  <button
                    onClick={startNewDay}
                    className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700"
                  >
                    Start New Day
                  </button>
                </div>
              </div>
            </header>

            <main className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

              {/* Top 3 Priorities */}
              <section className="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 className="text-2xl font-bold text-slate-800 mb-4">‚≠ê Top 3 Priorities</h2>
                <div className="space-y-4">
                  {topThree.length > 0 ? (
                    topThree.map(task => (
                      <TaskCard
                        key={task.id}
                        task={task}
                        onUpdate={handleUpdateTask}
                        onDelete={() => handleDeleteTask(task.id, setTopThree)}
                        onDemote={() => demoteTask(task.id)}
                        onLaunchAI={() => setAiTask(task)}
                        isTopThree={true}
                        user={user}
                      />
                    ))
                  ) : (
                    <p className="text-slate-500 text-center py-4">Promote tasks from your brain dump to focus on them.</p>
                  )}
                  {topThree.length < 3 && Array.from({ length: 3 - topThree.length }).map((_, i) => (
                    <div key={i} className="p-4 rounded-lg border-2 border-dashed border-slate-300 text-center text-slate-400">
                      Empty Priority Slot
                    </div>
                  ))}
                </div>
              </section>

              {/* User's Personal Non-Negotiables */}
              {isWeekday && user.settings.nonNegotiables.length > 0 && (
                <section className="bg-white p-6 rounded-lg shadow-md mb-8">
                  <h2 className="text-2xl font-bold text-slate-800 mb-4">üóìÔ∏è Your Daily Non-Negotiables</h2>
                  <div className="space-y-3">
                    {nonNegotiableTasks.map(task => (
                      <div key={task.id} className="p-3 rounded-lg flex items-center gap-4 bg-slate-50 border border-slate-200">
                        <input
                          type="checkbox"
                          checked={task.isCompleted}
                          onChange={(e) => handleUpdateNonNegotiableTask({ ...task, isCompleted: e.target.checked })}
                          className="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 shrink-0"
                        />
                        <div className="flex-1">
                          <p className="font-medium text-slate-800">{task.text}</p>
                          <p className="text-sm text-slate-500">{task.duration} minutes</p>
                        </div>
                        <div className="flex items-center gap-2">
                          <input
                            type="time"
                            value={task.scheduledTime || ''}
                            onChange={(e) => handleUpdateNonNegotiableTask({ ...task, scheduledTime: e.target.value })}
                            className="block w-32 text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500"
                          />
                          <button
                            onClick={() => {
                              const calendarUrl = getCalendarUrl(task, user.settings.calendarProvider);
                              if (calendarUrl) {
                                if (user.settings.calendarProvider === 'apple') {
                                  const link = document.createElement('a');
                                  link.href = calendarUrl;
                                  link.download = `${task.text.replace(/[^a-z0-9]/gi, '_')}.ics`;
                                  link.click();
                                } else {
                                  window.open(calendarUrl, '_blank');
                                }
                              }
                            }}
                            disabled={!task.scheduledTime}
                            className="p-2 rounded-md bg-white border border-slate-300 text-slate-500 hover:bg-slate-50 disabled:opacity-50"
                          >
                            <CalendarIcon className="w-5 h-5" />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </section>
              )}

              {/* Brain Dump */}
              <section className="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 className="text-2xl font-bold text-slate-800 mb-4">üß† Brain Dump</h2>
                <form onSubmit={handleAddTask} className="flex gap-2 mb-4">
                  <input
                    type="text"
                    value={newTaskText}
                    onChange={(e) => setNewTaskText(e.target.value)}
                    placeholder="Add a new task..."
                    className="flex-grow block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"
                  />
                  <button type="submit" className="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 flex items-center justify-center">
                    <PlusIcon className="w-5 h-5" />
                  </button>
                </form>
                <div className="space-y-3 max-h-96 overflow-y-auto">
                  {brainDump.length > 0 ? (
                    brainDump.map(task => (
                      <TaskCard
                        key={task.id}
                        task={task}
                        onUpdate={handleUpdateTask}
                        onDelete={() => handleDeleteTask(task.id, setBrainDump)}
                        onPromote={() => promoteTask(task.id)}
                        onLaunchAI={() => setAiTask(task)}
                        isTopThree={false}
                        user={user}
                      />
                    ))
                  ) : (
                    <p className="text-slate-500 text-center py-4">Brain dump all your tasks for the day here.</p>
                  )}
                </div>
              </section>

              {/* Completed Tasks */}
              <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                <button
                  onClick={() => setShowCompleted(!showCompleted)}
                  className="w-full flex justify-between items-center text-left text-xl font-bold text-slate-800 focus:outline-none"
                >
                  <span>‚úÖ Completed Tasks ({completedHistory.length})</span>
                  <ChevronDownIcon className={`w-6 h-6 transform transition-transform ${showCompleted ? 'rotate-180' : ''}`} />
                </button>
                {showCompleted && completedHistory.length > 0 && (
                  <div className="mt-4 space-y-2">
                    {completedHistory.slice(0, 10).map(task => (
                      <div key={task.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <div>
                          <p className="font-medium text-slate-900">{task.text}</p>
                          <p className="text-sm text-slate-500">{new Date(task.completedAt).toLocaleString()}</p>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

            </main>

            {/* AI Modal */}
            {aiTask && <AIModal task={aiTask} user={user} onClose={() => setAiTask(null)} />}

            {/* Settings Modal */}
            {showSettings && (
              <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
                  <h2 className="text-lg font-semibold text-slate-800 mb-4">Settings</h2>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-slate-700">Name</label>
                      <p className="text-slate-900">{user.name}</p>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700">Calendar</label>
                      <p className="text-slate-900 capitalize">{user.settings.calendarProvider}</p>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700">AI Assistant</label>
                      <p className="text-slate-900">{user.settings.aiProvider === 'none' ? 'Disabled' : user.settings.aiProvider}</p>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700">Non-Negotiables</label>
                      <p className="text-slate-900">{user.settings.nonNegotiables.length} daily tasks</p>
                    </div>
                  </div>
                  <div className="flex gap-3 mt-6">
                    <button
                      onClick={() => {
                        if (confirm('Are you sure you want to sign out?')) {
                          localStorage.removeItem('momentum-current-user');
                          window.location.reload();
                        }
                      }}
                      className="flex-1 px-4 py-2 text-red-600 border border-red-300 rounded-lg hover:bg-red-50"
                    >
                      Sign Out
                    </button>
                    <button
                      onClick={() => setShowSettings(false)}
                      className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      Close
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      };

      // Root App Component
      const App = () => {
        const [currentUser, setCurrentUser] = useState(UserManager.getCurrentUser());

        if (!currentUser) {
          return <SetupWizard onComplete={setCurrentUser} />;
        }

        return <MomentumApp user={currentUser} />;
      };

      // Render the app
      const rootElement = document.getElementById('root');
      if (rootElement) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
      } else {
        console.error('Root element not found');
      }
    </script>
  </body>
</html>
