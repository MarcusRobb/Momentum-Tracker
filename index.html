<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Momentum: Time Boxing & LAPS Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM from CDN (UMD builds) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <!-- The root element for the React app -->
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useCallback, useEffect, useMemo, useRef } = React;

      // UUID generation with fallback for older browsers
      const generateUUID = () => {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) {
          return crypto.randomUUID();
        }
        // Fallback for older browsers
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0;
          const v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      };

      // useLocalStorage hook
      const useLocalStorage = (key, initialValue) => {
        const [storedValue, setStoredValue] = useState(() => {
          if (typeof window === 'undefined') {
            return initialValue;
          }
          try {
            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
          } catch (error) {
            console.error(error);
            return initialValue;
          }
        });

        const setValue = (value) => {
          try {
            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            if (typeof window !== 'undefined') {
              window.localStorage.setItem(key, JSON.stringify(valueToStore));
            }
          } catch (error) {
            console.error(error);
          }
        };

        useEffect(() => {
          const handleStorageChange = (e) => {
            if (e.key === key && e.newValue) {
              setStoredValue(JSON.parse(e.newValue));
            }
          };
          window.addEventListener('storage', handleStorageChange);
          return () => window.removeEventListener('storage', handleStorageChange);
        }, [key]);

        return [storedValue, setValue];
      };

      // Icon Components
      const PlusIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      );

      const TrashIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      );

      const ArrowUpCircleIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="16 12 12 8 8 12"></polyline>
          <line x1="12" y1="16" x2="12" y2="8"></line>
        </svg>
      );

      const ArrowDownCircleIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="8 12 12 16 16 12"></polyline>
          <line x1="12" y1="8" x2="12" y2="16"></line>
        </svg>
      );

      const ChevronDownIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      );

      const ChevronUpIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <polyline points="18 15 12 9 6 15"></polyline>
        </svg>
      );

      const DollarSignIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <line x1="12" y1="1" x2="12" y2="23"></line>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
      );

      const CalendarIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      );

      const RestoreIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M9 14l-4-4 4-4"></path>
          <path d="M5 10h11a4 4 0 0 1 4 4v1"></path>
        </svg>
      );

      const LightbulbIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M9 18h6"></path>
          <path d="M10 22h4"></path>
          <path d="M12 2a7 7 0 0 0-7 7c0 3.03 1.09 5.4 2.78 6.88L12 22l4.22-6.12C17.91 14.4 19 11.03 19 9a7 7 0 0 0-7-7z"></path>
        </svg>
      );

      const SparkleIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M12 2L9.1 8.26 3 9.27l4.55 4.34L6.2 20 12 16.54 17.8 20l-1.35-6.39L21 9.27l-6.1-1.01L12 2z"></path>
          <path d="M5 3v4"></path>
          <path d="M19 17v4"></path>
          <path d="M3 5h4"></path>
          <path d="M17 19h4"></path>
        </svg>
      );

      const XIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      );

      const EditIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
      );

      const ClipboardCopyIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      );

      const DownloadIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
      );

      // CSV Export Utilities
      const downloadCSV = (data, filename) => {
        const blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const arrayToCSV = (array) => {
        if (!array || array.length === 0) return '';

        const headers = Object.keys(array[0]);
        const csvHeaders = headers.join(',');

        const csvRows = array.map(row =>
          headers.map(header => {
            const value = row[header];
            // Escape quotes and wrap in quotes if contains comma, quote, or newline
            if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
              return `"${value.replace(/"/g, '""')}"`;
            }
            return value;
          }).join(',')
        );

        return [csvHeaders, ...csvRows].join('\n');
      };

      const exportLapsData = (lapsHistory) => {
        if (!lapsHistory || lapsHistory.length === 0) {
          alert('No LAPS data to export');
          return;
        }

        const csvData = arrayToCSV(lapsHistory);
        const filename = `laps-data-${new Date().toISOString().split('T')[0]}.csv`;
        downloadCSV(csvData, filename);
      };

      const exportAccountabilityData = (accountabilityHistory) => {
        if (!accountabilityHistory || accountabilityHistory.length === 0) {
          alert('No accountability data to export');
          return;
        }

        const csvData = arrayToCSV(accountabilityHistory);
        const filename = `accountability-data-${new Date().toISOString().split('T')[0]}.csv`;
        downloadCSV(csvData, filename);
      };

      const exportCompletedTasks = (completedHistory) => {
        if (!completedHistory || completedHistory.length === 0) {
          alert('No completed tasks to export');
          return;
        }

        const tasksForExport = completedHistory.map(task => ({
          task: task.text,
          completed_date: new Date(task.completedAt).toLocaleDateString(),
          completed_time: new Date(task.completedAt).toLocaleTimeString(),
          was_income_generating: task.isIncomeGenerating ? 'Yes' : 'No',
          notes: task.notes || '',
          scheduled_time: task.scheduledTime || '',
          duration_minutes: task.duration || ''
        }));

        const csvData = arrayToCSV(tasksForExport);
        const filename = `completed-tasks-${new Date().toISOString().split('T')[0]}.csv`;
        downloadCSV(csvData, filename);
      };

      const exportUncompletedTasks = (brainDump, topThree, nonNegotiableTasks, ideasVault) => {
        const timestamp = new Date().toISOString().split('T')[0];

        // Filter uncompleted tasks from each section
        const uncompletedBrainDump = brainDump.filter(task => !task.isCompleted);
        const uncompletedTopThree = topThree.filter(task => !task.isCompleted);
        const uncompletedNonNegotiables = nonNegotiableTasks.filter(task => !task.isCompleted);

        // Check if there are any uncompleted tasks
        const totalUncompleted = uncompletedBrainDump.length + uncompletedTopThree.length + uncompletedNonNegotiables.length + ideasVault.length;

        if (totalUncompleted === 0) {
          alert('No uncompleted tasks to export');
          return;
        }

        // Create summary
        const summary = {
          export_date: new Date().toLocaleDateString(),
          export_time: new Date().toLocaleTimeString(),
          uncompleted_top_three: uncompletedTopThree.length,
          uncompleted_brain_dump: uncompletedBrainDump.length,
          uncompleted_non_negotiables: uncompletedNonNegotiables.length,
          ideas_in_vault: ideasVault.length,
          total_uncompleted_items: totalUncompleted
        };

        let csvContent = '=== UNCOMPLETED TASKS EXPORT ===\n\n';
        csvContent += '=== SUMMARY ===\n';
        csvContent += arrayToCSV([summary]) + '\n\n';

        // Export Top 3 Priorities (uncompleted)
        if (uncompletedTopThree.length > 0) {
          csvContent += '=== TOP 3 PRIORITIES (UNCOMPLETED) ===\n';
          const topThreeForExport = uncompletedTopThree.map(task => ({
            section: 'Top 3 Priorities',
            task: task.text,
            description: task.description || '',
            scheduled_time: task.scheduledTime || '',
            duration_minutes: task.duration || '',
            is_income_generating: task.isIncomeGenerating ? 'Yes' : 'No',
            action_notes: task.notes || ''
          }));
          csvContent += arrayToCSV(topThreeForExport) + '\n\n';
        }

        // Export Brain Dump (uncompleted)
        if (uncompletedBrainDump.length > 0) {
          csvContent += '=== BRAIN DUMP (UNCOMPLETED) ===\n';
          const brainDumpForExport = uncompletedBrainDump.map(task => ({
            section: 'Brain Dump',
            task: task.text,
            description: task.description || '',
            scheduled_time: task.scheduledTime || '',
            duration_minutes: task.duration || '',
            is_income_generating: task.isIncomeGenerating ? 'Yes' : 'No',
            action_notes: task.notes || ''
          }));
          csvContent += arrayToCSV(brainDumpForExport) + '\n\n';
        }

        // Export Non-Negotiables (uncompleted)
        if (uncompletedNonNegotiables.length > 0) {
          csvContent += '=== NON-NEGOTIABLES (UNCOMPLETED) ===\n';
          const nonNegotiablesForExport = uncompletedNonNegotiables.map(task => ({
            section: 'Non-Negotiables',
            task: task.text,
            description: task.description || '',
            scheduled_time: task.scheduledTime || '',
            is_income_generating: task.isIncomeGenerating ? 'Yes' : 'No'
          }));
          csvContent += arrayToCSV(nonNegotiablesForExport) + '\n\n';
        }

        // Export Ideas Vault
        if (ideasVault.length > 0) {
          csvContent += '=== IDEAS VAULT ===\n';
          const ideasForExport = ideasVault.map(idea => ({
            section: 'Ideas Vault',
            idea: idea.text,
            description: idea.description || ''
          }));
          csvContent += arrayToCSV(ideasForExport) + '\n\n';
        }

        const filename = `uncompleted-tasks-${timestamp}.csv`;
        downloadCSV(csvContent, filename);
      };

      const exportAllData = (lapsHistory, accountabilityHistory, completedHistory, brainDump, topThree, ideasVault) => {
        const timestamp = new Date().toISOString().split('T')[0];

        // Create a comprehensive export
        const summary = {
          export_date: new Date().toLocaleDateString(),
          export_time: new Date().toLocaleTimeString(),
          total_laps_entries: lapsHistory.length,
          total_accountability_entries: accountabilityHistory.length,
          total_completed_tasks: completedHistory.length,
          current_brain_dump_tasks: brainDump.length,
          current_top_three_tasks: topThree.length,
          ideas_in_vault: ideasVault.length
        };

        let csvContent = '=== MOMENTUM TRACKER DATA EXPORT ===\n\n';
        csvContent += '=== SUMMARY ===\n';
        csvContent += arrayToCSV([summary]) + '\n\n';

        if (lapsHistory.length > 0) {
          csvContent += '=== LAPS DATA ===\n';
          csvContent += arrayToCSV(lapsHistory) + '\n\n';
        }

        if (accountabilityHistory.length > 0) {
          csvContent += '=== ACCOUNTABILITY DATA ===\n';
          csvContent += arrayToCSV(accountabilityHistory) + '\n\n';
        }

        if (completedHistory.length > 0) {
          csvContent += '=== COMPLETED TASKS ===\n';
          const tasksForExport = completedHistory.map(task => ({
            task: task.text,
            completed_date: new Date(task.completedAt).toLocaleDateString(),
            completed_time: new Date(task.completedAt).toLocaleTimeString(),
            was_income_generating: task.isIncomeGenerating ? 'Yes' : 'No',
            notes: task.notes || '',
            scheduled_time: task.scheduledTime || '',
            duration_minutes: task.duration || ''
          }));
          csvContent += arrayToCSV(tasksForExport) + '\n\n';
        }

        const filename = `momentum-tracker-full-export-${timestamp}.csv`;
        downloadCSV(csvContent, filename);
      };

      // Gemini Modal Component
      const GeminiModal = ({ task, onClose }) => {
        const [prompt, setPrompt] = useState('');
        const [response, setResponse] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState('');
        const [copySuccess, setCopySuccess] = useState('');

        const modalRef = useRef(null);
        const responseRef = useRef(null);

        useEffect(() => {
          const handleEsc = (event) => {
            if (event.key === 'Escape') onClose();
          };
          window.addEventListener('keydown', handleEsc);

          // Focus the first focusable element when the modal opens
          const focusableElements = modalRef.current?.querySelectorAll('button, textarea');
          focusableElements?.[0]?.focus();

          return () => window.removeEventListener('keydown', handleEsc);
        }, [onClose]);

        const handleSubmit = async (e) => {
          e.preventDefault();
          if (!prompt.trim() || isLoading) return;

          setIsLoading(true);
          setError('');
          setResponse('');
          setCopySuccess('');

          try {
            // SECURE APPROACH: Call our own API route, not Google directly
            // This ensures the API key stays on the server and is never exposed to the browser
            const res = await fetch('/api/gemini', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                // No API keys here! Only public data is sent to our secure server
              },
              body: JSON.stringify({
                task: {
                  id: task.id,
                  text: task.text,
                  notes: task.notes || '',
                  isIncomeGenerating: task.isIncomeGenerating || false
                },
                prompt: prompt.trim()
              }),
            });

            if (!res.ok) {
              const errorData = await res.json().catch(() => ({}));
              throw new Error(errorData.error || `Request failed with status ${res.status}`);
            }

            const data = await res.json();
            setResponse(data.response);
          } catch (err) {
            console.error("Failed to fetch from /api/gemini:", err);

            // Provide helpful error messages based on the type of error
            if (err.message.includes('404')) {
              setError('AI service not configured. Please set up the /api/gemini endpoint on your server.');
            } else if (err.message.includes('500')) {
              setError('Server error. Please check your API configuration and try again.');
            } else if (err.message.includes('Failed to fetch')) {
              setError('Network error. Please check your internet connection and try again.');
            } else {
              setError(err.message || 'Failed to get a response from the AI. Please try again.');
            }
          } finally {
            setIsLoading(false);
            setTimeout(() => {
              responseRef.current?.scrollTo({ top: responseRef.current.scrollHeight, behavior: 'smooth' });
            }, 100);
          }
        };

        const handleCopyResponse = async () => {
          try {
            await navigator.clipboard.writeText(response);
            setCopySuccess('Copied!');
            setTimeout(() => setCopySuccess(''), 2000);
          } catch (err) {
            console.error('Failed to copy text: ', err);
          }
        };

        return (
          <div
            className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm"
            aria-labelledby="gemini-modal-title"
            role="dialog"
            aria-modal="true"
            onClick={onClose}
          >
            <div
              ref={modalRef}
              className="bg-white rounded-xl shadow-2xl w-full max-w-2xl h-[90vh] max-h-[700px] flex flex-col transform transition-all"
              onClick={e => e.stopPropagation()}
            >
              <header className="flex items-center justify-between p-4 border-b border-slate-200 flex-shrink-0">
                <div className="flex items-center gap-3">
                  <SparkleIcon className="w-6 h-6 text-blue-500" />
                  <div>
                    <h2 id="gemini-modal-title" className="text-lg font-semibold text-slate-800">AI Assistant</h2>
                    <p className="text-sm text-slate-500">Working on: {task.text}</p>
                  </div>
                </div>
                <button
                  onClick={onClose}
                  className="p-2 rounded-md text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors"
                  aria-label="Close modal"
                >
                  <XIcon className="w-5 h-5" />
                </button>
              </header>

              <main ref={responseRef} className="flex-1 p-6 overflow-y-auto">
                {!response && !isLoading && !error && (
                  <div className="text-center text-slate-400 py-16 animate-fade-in">
                    <p className="text-lg">What do you need help with?</p>
                    <p className="text-sm mt-1">e.g., "Brainstorm 5 marketing angles..."</p>
                  </div>
                )}
                {isLoading && (
                  <div className="flex items-center justify-center gap-3 text-slate-600 animate-fade-in">
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500"></div>
                    <span>Thinking...</span>
                  </div>
                )}
                {error && (
                  <div className="bg-red-50 border-l-4 border-red-400 p-4 rounded-r-lg animate-fade-in">
                    <p className="font-bold text-red-800">Error</p>
                    <p className="text-red-700">{error}</p>
                  </div>
                )}
                {response && (
                  <div className="prose prose-slate max-w-none relative animate-fade-in">
                    <button
                      onClick={handleCopyResponse}
                      className="absolute top-0 right-0 -mt-2 -mr-2 p-2 text-sm rounded-md bg-slate-100 text-slate-600 hover:bg-slate-200 flex items-center gap-1.5 transition-all"
                      aria-label="Copy AI response"
                    >
                      {copySuccess ? <>{copySuccess}</> : <><ClipboardCopyIcon className="w-4 h-4" /> Copy</>}
                    </button>
                    <pre className="whitespace-pre-wrap font-sans bg-slate-50 p-4 rounded-lg text-slate-800">{response}</pre>
                  </div>
                )}
              </main>

              <footer className="p-4 border-t border-slate-200 flex-shrink-0">
                <form onSubmit={handleSubmit} className="flex gap-3">
                  <textarea
                    value={prompt}
                    onChange={(e) => setPrompt(e.target.value)}
                    placeholder="Ask for help with this task..."
                    className="flex-1 resize-none rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-3"
                    rows="2"
                    disabled={isLoading}
                  />
                  <button
                    type="submit"
                    disabled={!prompt.trim() || isLoading}
                    className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                  >
                    <SparkleIcon className="w-4 h-4" />
                    {isLoading ? 'Thinking...' : 'Ask AI'}
                  </button>
                </form>
              </footer>
            </div>
          </div>
        );
      };

      // Accountability Tracker Component
      const AccountabilityTracker = ({ accountabilityHistory, setAccountabilityHistory }) => {
        const [weekOffset, setWeekOffset] = useState(0);

        // Helper function to get dates for a specific week
        const getWeekDates = (weekOffset = 0) => {
          const weekDates = [];
          const today = new Date();
          today.setDate(today.getDate() + weekOffset * 7);

          const currentDay = today.getDay();
          const diff = today.getDate() - currentDay + (currentDay === 0 ? -6 : 1);
          const monday = new Date(today.setDate(diff));

          for (let i = 0; i < 5; i++) {
            const day = new Date(monday);
            day.setDate(monday.getDate() + i);
            weekDates.push(day);
          }
          return weekDates;
        };

        const toISODateString = (date) => date.toISOString().split('T')[0];
        const toFriendlyDate = (date) => date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        const weekDates = getWeekDates(weekOffset);
        const weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        const activities = ['appointment', 'spokeToPerson', 'taughtSomeone', 'madeOffer'];
        const activityLabels = {
          appointment: 'Appointment Y/N',
          spokeToPerson: 'Spoke to 1 person Y/N',
          taughtSomeone: 'Taught Someone Y/N',
          madeOffer: 'Made an offer Y/N',
        };

        const handleCheckboxChange = (date, activity, checked) => {
          setAccountabilityHistory(prevHistory => {
            const entryIndex = prevHistory.findIndex(e => e.date === date);
            if (entryIndex > -1) {
              const newHistory = [...prevHistory];
              newHistory[entryIndex] = { ...newHistory[entryIndex], [activity]: checked };
              return newHistory;
            } else {
              const newEntry = {
                date,
                appointment: false,
                spokeToPerson: false,
                taughtSomeone: false,
                madeOffer: false,
                [activity]: checked
              };
              return [...prevHistory, newEntry];
            }
          });
        };

        const weekData = weekDates.map(date => {
          const dateStr = toISODateString(date);
          return accountabilityHistory.find(entry => entry.date === dateStr) || {
            date: dateStr,
            appointment: false,
            spokeToPerson: false,
            taughtSomeone: false,
            madeOffer: false
          };
        });

        const totals = activities.reduce((acc, activity) => {
          acc[activity] = weekData.filter(day => day[activity]).length;
          return acc;
        }, {});

        const weekRange = `Week of ${toFriendlyDate(weekDates[0])} - ${toFriendlyDate(weekDates[4])}`;

        const handleFinalizeWeek = () => {
          if (window.confirm(`Are you sure you want to finalize the week of ${weekRange}? This will lock the data and move to the next week.`)) {
            // Mark this week as finalized in localStorage
            const finalizedWeeks = JSON.parse(localStorage.getItem('finalized-weeks') || '[]');
            const weekKey = `${weekDates[0].getFullYear()}-W${Math.ceil(weekDates[0].getDate() / 7)}`;

            if (!finalizedWeeks.includes(weekKey)) {
              finalizedWeeks.push(weekKey);
              localStorage.setItem('finalized-weeks', JSON.stringify(finalizedWeeks));
            }

            alert(`Week finalized! Your accountability data for ${weekRange} has been saved.`);
          }
        };

        const isCurrentWeek = weekOffset === 0;
        const finalizedWeeks = JSON.parse(localStorage.getItem('finalized-weeks') || '[]');
        const weekKey = `${weekDates[0].getFullYear()}-W${Math.ceil(weekDates[0].getDate() / 7)}`;
        const isWeekFinalized = finalizedWeeks.includes(weekKey);

        return (
          <div className="bg-white p-6 rounded-lg shadow-md">
            <div className="flex justify-between items-center mb-4">
              <div>
                <h2 className="text-2xl font-bold text-slate-800">Accountability Process</h2>
                <p className="text-sm text-slate-500">{weekRange}</p>
                {isWeekFinalized && (
                  <p className="text-sm text-green-600 font-medium">✅ Week Finalized</p>
                )}
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => setWeekOffset(weekOffset - 1)}
                  className="px-3 py-1 text-sm font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500"
                >
                  ← Previous Week
                </button>
                <button
                  onClick={() => setWeekOffset(weekOffset + 1)}
                  disabled={weekOffset >= 0}
                  className="px-3 py-1 text-sm font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Next Week →
                </button>
                {accountabilityHistory.length > 0 && (
                  <button
                    onClick={() => exportAccountabilityData(accountabilityHistory)}
                    className="px-3 py-1 text-sm font-medium text-blue-600 bg-blue-50 rounded-md hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    title="Export accountability data to CSV"
                  >
                    <DownloadIcon className="w-4 h-4 inline mr-1" />
                    Export
                  </button>
                )}
                {isCurrentWeek && !isWeekFinalized && (
                  <button
                    onClick={handleFinalizeWeek}
                    className="px-4 py-1 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                  >
                    Finalize Week
                  </button>
                )}
              </div>
            </div>
            <div className="overflow-x-auto">
              <table className="min-w-full border border-slate-300 text-sm">
                <thead className="bg-blue-500 text-white">
                  <tr>
                    <th className="p-3 text-left font-semibold border-r border-blue-400">Activity</th>
                    {activities.map(activity => (
                      <th key={activity} className="p-3 text-center font-semibold border-r border-blue-400 last:border-r-0">{activityLabels[activity]}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {weekDays.map((day, index) => {
                    const dateStr = toISODateString(weekDates[index]);
                    const dayData = weekData[index];
                    return (
                      <tr key={day} className="border-b border-slate-200">
                        <td className="p-3 font-medium bg-slate-100 border-r border-slate-300 text-slate-900">{day}</td>
                        {activities.map(activity => (
                          <td key={activity} className="p-3 text-center border-r border-slate-300">
                            <input
                              type="checkbox"
                              className="h-5 w-5 rounded border-gray-400 text-blue-600 focus:ring-blue-500 cursor-pointer"
                              checked={!!dayData[activity]}
                              onChange={e => handleCheckboxChange(dateStr, activity, e.target.checked)}
                              aria-label={`${activityLabels[activity]} for ${day}`}
                            />
                          </td>
                        ))}
                      </tr>
                    );
                  })}
                  <tr className="bg-blue-500 text-white font-bold">
                    <td className="p-3 border-r border-blue-400">Total</td>
                    {activities.map(activity => (
                      <td key={activity} className="p-3 text-center border-r border-blue-400 last:border-r-0">
                        {totals[activity]}
                      </td>
                    ))}
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        );
      };

      // Reports Component
      const Reports = ({ lapsHistory, accountabilityHistory }) => {
        // LAPS Conversion Funnel
        const getWeeklyLaps = () => {
          const today = new Date();
          const dayOfWeek = today.getDay();
          const startOfWeek = new Date(today);
          startOfWeek.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
          const startOfWeekStr = startOfWeek.toISOString().split('T')[0];
          const todayStr = today.toISOString().split('T')[0];

          return lapsHistory
            .filter(d => d.date >= startOfWeekStr && d.date <= todayStr)
            .reduce((acc, curr) => ({
                leads: acc.leads + curr.leads,
                appointments: acc.appointments + curr.appointments,
                presentations: acc.presentations + curr.presentations,
                sales: acc.sales + curr.sales,
            }), { leads: 0, appointments: 0, presentations: 0, sales: 0 });
        };

        const weeklyLaps = getWeeklyLaps();
        const leadToApptRate = weeklyLaps.leads > 0 ? ((weeklyLaps.appointments / weeklyLaps.leads) * 100).toFixed(1) : '0.0';
        const apptToPresRate = weeklyLaps.appointments > 0 ? ((weeklyLaps.presentations / weeklyLaps.appointments) * 100).toFixed(1) : '0.0';
        const presToSaleRate = weeklyLaps.presentations > 0 ? ((weeklyLaps.sales / weeklyLaps.presentations) * 100).toFixed(1) : '0.0';

        // Monthly Trends
        const getMonthlyTrends = () => {
          const trends = {};
          const today = new Date();

          for (let i = 0; i < 4; i++) {
              const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
              const monthKey = date.toLocaleString('default', { month: 'short', year: '2-digit' });

              const monthData = lapsHistory
                  .filter(d => d.date.startsWith(`${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`))
                  .reduce((acc, curr) => ({
                      date: acc.date,
                      leads: acc.leads + curr.leads,
                      appointments: acc.appointments + curr.appointments,
                      presentations: acc.presentations + curr.presentations,
                      sales: acc.sales + curr.sales,
                  }), { date: monthKey, leads: 0, appointments: 0, presentations: 0, sales: 0 });

              trends[monthKey] = monthData;
          }
          return Object.values(trends).reverse();
        };
        const monthlyTrends = getMonthlyTrends();

        // Accountability Heatmap
        const getHeatmapData = () => {
          const today = new Date();
          const year = today.getFullYear();
          const month = today.getMonth();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const firstDayOfMonth = new Date(year, month, 1).getDay();
          const offset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;

          const heatmap = Array(offset).fill(null);
          for (let i = 1; i <= daysInMonth; i++) {
              const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
              const entry = accountabilityHistory.find(d => d.date === dateStr);
              if (entry) {
                  const score = Object.values(entry).filter(v => v === true).length;
                  heatmap.push({ date: i, score });
              } else {
                  heatmap.push({ date: i, score: 0 });
              }
          }
          return heatmap;
        };
        const heatmapData = getHeatmapData();
        const getColorForScore = (score) => {
          if (score >= 4) return 'bg-green-600';
          if (score === 3) return 'bg-green-500';
          if (score === 2) return 'bg-yellow-400';
          if (score === 1) return 'bg-yellow-300';
          return 'bg-slate-200';
        };

        return (
          <div className="space-y-12">

            {/* LAPS Conversion Funnel */}
            <section>
              <h3 className="text-xl font-bold text-slate-800 mb-4">This Week's LAPS Conversion Funnel</h3>
              <div className="flex flex-col md:flex-row items-center justify-around gap-2 text-center flex-wrap">

                <div className="p-4 rounded-lg bg-slate-100 min-w-[100px]">
                  <p className="text-sm text-slate-500">Leads</p>
                  <p className="text-3xl font-bold">{weeklyLaps.leads}</p>
                </div>

                <div className="flex flex-col items-center">
                  <div className="text-2xl font-semibold text-slate-400">→</div>
                  <p className="text-lg font-bold text-blue-600">{leadToApptRate}%</p>
                  <p className="text-xs text-slate-500 -mt-1">conversion</p>
                </div>

                <div className="p-4 rounded-lg bg-slate-100 min-w-[100px]">
                  <p className="text-sm text-slate-500">Appointments</p>
                  <p className="text-3xl font-bold">{weeklyLaps.appointments}</p>
                </div>

                <div className="flex flex-col items-center">
                  <div className="text-2xl font-semibold text-slate-400">→</div>
                  <p className="text-lg font-bold text-blue-600">{apptToPresRate}%</p>
                  <p className="text-xs text-slate-500 -mt-1">conversion</p>
                </div>

                <div className="p-4 rounded-lg bg-slate-100 min-w-[100px]">
                  <p className="text-sm text-slate-500">Presentations</p>
                  <p className="text-3xl font-bold">{weeklyLaps.presentations}</p>
                </div>

                <div className="flex flex-col items-center">
                  <div className="text-2xl font-semibold text-slate-400">→</div>
                  <p className="text-lg font-bold text-blue-600">{presToSaleRate}%</p>
                  <p className="text-xs text-slate-500 -mt-1">conversion</p>
                </div>

                <div className="p-4 rounded-lg bg-slate-100 min-w-[100px]">
                  <p className="text-sm text-slate-500">Sales</p>
                  <p className="text-3xl font-bold">{weeklyLaps.sales}</p>
                </div>

              </div>
            </section>

            {/* Monthly Trends */}
            <section>
              <h3 className="text-xl font-bold text-slate-800 mb-4">Monthly LAPS Trends</h3>
              <div className="space-y-4">
                {monthlyTrends.map(month => (
                  <div key={month.date}>
                    <h4 className="font-semibold text-slate-600 mb-2">{month.date}</h4>
                    <div className="grid grid-cols-1 sm:grid-cols-4 gap-x-6 gap-y-2 text-sm">
                      {Object.entries(month).map(([key, value]) => {
                        if (key === 'date') return null;
                        const maxVal = Math.max(...monthlyTrends.flatMap(m => Object.values(m).filter(v => typeof v === 'number'))) || 1;
                        const width = (Number(value) / maxVal) * 100;
                        return (
                          <div key={key} className="flex items-center gap-2">
                            <span className="w-28 capitalize shrink-0">{key}</span>
                            <div className="w-full bg-slate-200 rounded-full h-5">
                                <div className="bg-blue-500 h-5 rounded-full text-white text-xs flex items-center justify-end pr-2" style={{ width: `${width}%` }}>
                                    <span className="font-bold">{value}</span>
                                </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            </section>

            {/* Accountability Heatmap */}
            <section>
              <h3 className="text-xl font-bold text-slate-800 mb-4">This Month's Accountability Heatmap</h3>
               <div className="grid grid-cols-7 gap-1 text-center text-xs font-semibold text-slate-500 mb-2">
                  <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
              </div>
              <div className="grid grid-cols-7 gap-1">
                  {heatmapData.map((day, index) => (
                      day ? (
                          <div key={index} title={`${day.score} activities on day ${day.date}`} className={`w-full aspect-square rounded ${getColorForScore(day.score)} flex items-center justify-center text-white font-bold`}>
                              {day.date}
                          </div>
                      ) : (
                          <div key={index}></div>
                      )
                  ))}
              </div>
               <div className="flex justify-end items-center gap-4 mt-2 text-xs">
                  <span>Less</span>
                  <div className="w-4 h-4 rounded bg-slate-200"></div>
                  <div className="w-4 h-4 rounded bg-yellow-300"></div>
                  <div className="w-4 h-4 rounded bg-yellow-400"></div>
                  <div className="w-4 h-4 rounded bg-green-500"></div>
                  <div className="w-4 h-4 rounded bg-green-600"></div>
                  <span>More</span>
              </div>
            </section>

          </div>
        );
      };

      // Enhanced LAPS Tracker Component
      const LapsTracker = ({ lapsHistory, setLapsHistory }) => {
        const todayStr = new Date().toISOString().split('T')[0];

        const todayData = useMemo(() => {
          return lapsHistory.find(d => d.date === todayStr) || { date: todayStr, leads: 0, appointments: 0, presentations: 0, sales: 0 };
        }, [lapsHistory, todayStr]);

        const [currentLaps, setCurrentLaps] = useState(todayData);
        const [showHistory, setShowHistory] = useState(false);
        const [saveStatus, setSaveStatus] = useState('idle');

        useEffect(() => {
          setCurrentLaps(todayData);
        }, [todayData]);

        const handleInputChange = (e) => {
          const { name, value } = e.target;
          setCurrentLaps(prev => ({ ...prev, [name]: Number(value) < 0 ? 0 : Number(value) }));
          setSaveStatus('idle');
        };

        const handleSave = () => {
          setSaveStatus('saving');
          setLapsHistory(prevHistory => {
            const existingIndex = prevHistory.findIndex(d => d.date === todayStr);
            if (existingIndex > -1) {
              const newHistory = [...prevHistory];
              newHistory[existingIndex] = { ...currentLaps, date: todayStr };
              return newHistory;
            } else {
              return [...prevHistory, { ...currentLaps, date: todayStr }];
            }
          });
          setTimeout(() => setSaveStatus('saved'), 300);
          setTimeout(() => setSaveStatus('idle'), 2500);
        };

        // Calculate totals
        const getWeeklyTotal = () => {
          const today = new Date();
          const dayOfWeek = today.getDay();
          const startOfWeek = new Date(today);
          startOfWeek.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1));
          const startOfWeekStr = startOfWeek.toISOString().split('T')[0];

          return lapsHistory
            .filter(d => d.date >= startOfWeekStr && d.date <= todayStr)
            .reduce((acc, curr) => ({
              leads: acc.leads + curr.leads,
              appointments: acc.appointments + curr.appointments,
              presentations: acc.presentations + curr.presentations,
              sales: acc.sales + curr.sales,
            }), { leads: 0, appointments: 0, presentations: 0, sales: 0 });
        };

        const getMonthlyTotal = () => {
          const today = new Date();
          const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
          const startOfMonthStr = startOfMonth.toISOString().split('T')[0];

          return lapsHistory
            .filter(d => d.date >= startOfMonthStr && d.date <= todayStr)
            .reduce((acc, curr) => ({
              leads: acc.leads + curr.leads,
              appointments: acc.appointments + curr.appointments,
              presentations: acc.presentations + curr.presentations,
              sales: acc.sales + curr.sales,
            }), { leads: 0, appointments: 0, presentations: 0, sales: 0 });
        };

        const weeklyTotal = getWeeklyTotal();
        const monthlyTotal = getMonthlyTotal();

        return (
          <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-2xl font-bold text-slate-800 mb-4">📊 LAPS Tracker</h2>

            <div className="mb-6">
              <h3 className="text-lg font-semibold text-slate-700 mb-3">Today's Laps ({todayStr})</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                {['leads', 'appointments', 'presentations', 'sales'].map(key => (
                  <div key={key}>
                    <label htmlFor={key} className="block text-sm font-medium text-slate-600 capitalize">{key}</label>
                    <input
                      type="number"
                      name={key}
                      id={key}
                      value={currentLaps[key]}
                      onChange={handleInputChange}
                      className="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"
                      min="0"
                    />
                  </div>
                ))}
              </div>
              <button
                onClick={handleSave}
                className={`px-4 py-2 rounded-md font-medium transition-colors ${
                  saveStatus === 'saved' ? 'bg-green-500 text-white' :
                  saveStatus === 'saving' ? 'bg-blue-400 text-white' :
                  'bg-blue-500 text-white hover:bg-blue-600'
                }`}
                disabled={saveStatus === 'saving'}
              >
                {saveStatus === 'saved' ? '✓ Saved!' : saveStatus === 'saving' ? 'Saving...' : 'Save Today\'s LAPS'}
              </button>
            </div>

            {/* Totals */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <h4 className="font-semibold text-slate-700 mb-2">This Week's Total</h4>
                <div className="grid grid-cols-2 gap-2 text-sm">
                  <div className="bg-slate-50 p-2 rounded">Leads: <span className="font-bold">{weeklyTotal.leads}</span></div>
                  <div className="bg-slate-50 p-2 rounded">Appointments: <span className="font-bold">{weeklyTotal.appointments}</span></div>
                  <div className="bg-slate-50 p-2 rounded">Presentations: <span className="font-bold">{weeklyTotal.presentations}</span></div>
                  <div className="bg-slate-50 p-2 rounded">Sales: <span className="font-bold">{weeklyTotal.sales}</span></div>
                </div>
              </div>
              <div>
                <h4 className="font-semibold text-slate-700 mb-2">This Month's Total</h4>
                <div className="grid grid-cols-2 gap-2 text-sm">
                  <div className="bg-slate-50 p-2 rounded">Leads: <span className="font-bold">{monthlyTotal.leads}</span></div>
                  <div className="bg-slate-50 p-2 rounded">Appointments: <span className="font-bold">{monthlyTotal.appointments}</span></div>
                  <div className="bg-slate-50 p-2 rounded">Presentations: <span className="font-bold">{monthlyTotal.presentations}</span></div>
                  <div className="bg-slate-50 p-2 rounded">Sales: <span className="font-bold">{monthlyTotal.sales}</span></div>
                </div>
              </div>
            </div>

            {/* History */}
            <div>
              <div className="flex justify-between items-center mb-4">
                <button
                  onClick={() => setShowHistory(!showHistory)}
                  className="flex items-center text-left text-lg font-semibold text-slate-700 focus:outline-none"
                >
                  <span>LAPS History ({lapsHistory.length} days)</span>
                  <ChevronDownIcon className={`w-5 h-5 ml-2 transform transition-transform ${showHistory ? 'rotate-180' : ''}`} />
                </button>
                {lapsHistory.length > 0 && (
                  <button
                    onClick={() => exportLapsData(lapsHistory)}
                    className="flex items-center gap-2 px-3 py-1 text-sm font-medium text-blue-600 bg-blue-50 rounded-md hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    title="Export LAPS data to CSV"
                  >
                    <DownloadIcon className="w-4 h-4" />
                    Export CSV
                  </button>
                )}
              </div>
              {showHistory && (
                <div className="overflow-x-auto rounded-lg border border-slate-200">
                  <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-50">
                      <tr>
                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Leads</th>
                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Appointments</th>
                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Presentations</th>
                        <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Sales</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                      {lapsHistory.slice().reverse().map(day => (
                        <tr key={day.date}>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">{new Date(day.date).toLocaleDateString()}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{day.leads}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{day.appointments}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{day.presentations}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{day.sales}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  {lapsHistory.length === 0 && (
                    <p className="text-center py-4 text-slate-500">No LAPS data yet. Start tracking today!</p>
                  )}
                </div>
              )}
            </div>
          </div>
        );
      };

      // Instructions Component
      const Instructions = () => {
        const [isOpen, setIsOpen] = useState(false);

        return (
          <div className="bg-white rounded-lg shadow-sm mb-8">
            <button
              onClick={() => setIsOpen(!isOpen)}
              className="w-full flex justify-between items-center p-4 text-left text-lg font-semibold text-slate-700 focus:outline-none"
            >
              <span>Time Boxing Instructions & Tips</span>
              <ChevronDownIcon className={`w-6 h-6 transform transition-transform ${isOpen ? 'rotate-180' : ''}`} />
            </button>
            {isOpen && (
              <div className="p-6 border-t border-slate-200 text-slate-700">
                <p className="text-base mb-4">
                  Here's a ripper strategy to keep you focused and make sure you're raking in the cash. It's all about being intentional and focused on actions that drive real results for your business.
                </p>

                <h4 className="font-semibold text-slate-800 text-lg mb-3">Step-by-Step Instructions</h4>
                <ol className="list-decimal list-outside pl-5 space-y-3 mb-6">
                  <li>
                    <strong className="font-semibold text-slate-900">Brain Dump Everything You Need to Do:</strong> Grab a blank piece of paper and jot down absolutely all the tasks running through your head.
                    <em className="block text-sm text-slate-500 pl-2 border-l-2 border-slate-200 ml-2 mt-1 italic">Tip: This should be a fresh brain dump every single day.</em>
                  </li>
                  <li>
                    <strong className="font-semibold text-slate-900">Select Your Top Three Tasks:</strong> From your list, circle just three items to focus on.
                    <em className="block text-sm text-slate-500 pl-2 border-l-2 border-slate-200 ml-2 mt-1 italic">Crucial Step: One of these three tasks must be a direct income-generating activity (e.g., talking to a customer, closing a deal, sending offers).</em>
                  </li>
                  <li>
                    <strong className="font-semibold text-slate-900">Schedule These Three Tasks:</strong> Book specific times in your calendar for each task.
                    <em className="block text-sm text-slate-500 pl-2 border-l-2 border-slate-200 ml-2 mt-1 italic">Tip: This creates an appointment with yourself for accountability.</em>
                  </li>
                  <li>
                    <strong className="font-semibold text-slate-900">Detail Action Points for Each Task:</strong> In the notes for each scheduled task, create a bullet-point list of the specific actions required.
                    <em className="block text-sm text-slate-500 pl-2 border-l-2 border-slate-200 ml-2 mt-1 italic">Tip: This pre-planning removes hesitation.</em>
                  </li>
                  <li>
                    <strong className="font-semibold text-slate-900">Execute Your Plan:</strong> When the time comes, show up and get it done. You learn by doing.
                  </li>
                </ol>

                <h4 className="font-semibold text-slate-800 text-lg mb-3">Key Tips for Success</h4>
                <ul className="list-disc list-outside pl-5 space-y-2">
                  <li><strong className="font-semibold text-slate-900">Consistency is King:</strong> This exercise takes 3-5 minutes a day. Do it religiously.</li>
                  <li><strong className="font-semibold text-slate-900">Focus on Income-Generating Activities:</strong> Ask yourself: "Is what I'm doing right now putting cash in my bank today?".</li>
                  <li><strong className="font-semibold text-slate-900">Track Your Progress:</strong> Use the LAPS sheet (Leads, Appointments, Presentations, Sales) daily.</li>
                  <li><strong className="font-semibold text-slate-900">Dedicate Specific Time:</strong> Allocate at least one hour per day to these focused, income-generating actions.</li>
                  <li><strong className="font-semibold text-slate-900">Don't Overthink It:</strong> This is a "just do" moment. Action leads to clarity.</li>
                  <li><strong className="font-semibold text-slate-900">Learn by Doing:</strong> You get better by doing the work and getting feedback, not just by strategising.</li>
                </ul>
              </div>
            )}
          </div>
        );
      };

      // TaskCard Component (enhanced with description editing)
      const TaskCard = ({ task, onUpdate, onDelete, onPromote, onDemote, onSendToVault, onLaunchGemini, isTopThree }) => {
        const [isEditingTitle, setIsEditingTitle] = useState(false);
        const [isEditingDescription, setIsEditingDescription] = useState(false);
        const [showDescription, setShowDescription] = useState(false);
        const [tempTitle, setTempTitle] = useState(task.text);
        const [tempDescription, setTempDescription] = useState(task.description || '');

        const handleToggle = (field, value) => {
          onUpdate({ ...task, [field]: value });
        };

        const handleTitleEdit = () => {
          if (isEditingTitle) {
            if (tempTitle.trim()) {
              onUpdate({ ...task, text: tempTitle.trim() });
            } else {
              setTempTitle(task.text);
            }
            setIsEditingTitle(false);
          } else {
            setTempTitle(task.text);
            setIsEditingTitle(true);
          }
        };

        const handleDescriptionEdit = () => {
          if (isEditingDescription) {
            onUpdate({ ...task, description: tempDescription });
            setIsEditingDescription(false);
          } else {
            setTempDescription(task.description || '');
            setIsEditingDescription(true);
            setShowDescription(true);
          }
        };

        const handleTitleKeyPress = (e) => {
          if (e.key === 'Enter') {
            handleTitleEdit();
          } else if (e.key === 'Escape') {
            setTempTitle(task.text);
            setIsEditingTitle(false);
          }
        };

        const handleDescriptionKeyPress = (e) => {
          if (e.key === 'Escape') {
            setTempDescription(task.description || '');
            setIsEditingDescription(false);
          }
        };

        const handleAddToCalendar = () => {
          if (!task.scheduledTime || task.scheduledTime.match(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/) === null) {
            alert("Please set a valid time for the task first.");
            return;
          }

          const [hours, minutes] = task.scheduledTime.split(':').map(Number);

          const startTime = new Date();
          startTime.setHours(hours, minutes, 0, 0);

          const durationMinutes = task.duration || 60;
          const endTime = new Date(startTime.getTime() + durationMinutes * 60 * 1000);

          const toGoogleFormat = (date) => {
            return date.toISOString().replace(/-|:|\.\d{3}/g, '');
          };

          const calendarUrl = new URL('https://www.google.com/calendar/render');
          calendarUrl.searchParams.append('action', 'TEMPLATE');
          calendarUrl.searchParams.append('text', task.text);
          calendarUrl.searchParams.append('dates', `${toGoogleFormat(startTime)}/${toGoogleFormat(endTime)}`);
          calendarUrl.searchParams.append('details', task.notes || `Completing task: ${task.text}`);
          calendarUrl.searchParams.append('crm', 'BUSY');

          window.open(calendarUrl.toString() + '&colorId=11', '_blank', 'noopener,noreferrer');
        };

        return (
          <div className="p-4 rounded-lg transition-all bg-white border border-slate-200">
            <div className="flex items-start gap-4">
              <input
                type="checkbox"
                checked={task.isCompleted}
                onChange={(e) => handleToggle('isCompleted', e.target.checked)}
                className="mt-1 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <div className="flex-1">
                <div className="flex items-start gap-2">
                  {isEditingTitle ? (
                    <input
                      type="text"
                      value={tempTitle}
                      onChange={(e) => setTempTitle(e.target.value)}
                      onBlur={handleTitleEdit}
                      onKeyDown={handleTitleKeyPress}
                      className="flex-1 font-medium text-slate-800 bg-transparent border-b-2 border-blue-500 focus:outline-none"
                      autoFocus
                    />
                  ) : (
                    <p className="flex-1 font-medium text-slate-800">{task.text}</p>
                  )}
                  <button
                    onClick={handleTitleEdit}
                    className="p-1 text-slate-400 hover:text-slate-600 transition-colors"
                    title={isEditingTitle ? "Save title" : "Edit title"}
                  >
                    <EditIcon className="w-4 h-4" />
                  </button>
                </div>

                {/* Description Section */}
                <div className="mt-2">
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => setShowDescription(!showDescription)}
                      className="text-sm text-slate-500 hover:text-slate-700 flex items-center gap-1"
                    >
                      <ChevronDownIcon className={`w-4 h-4 transform transition-transform ${showDescription ? 'rotate-180' : ''}`} />
                      Description {task.description ? '(has content)' : '(empty)'}
                    </button>
                    <button
                      onClick={handleDescriptionEdit}
                      className="p-1 text-slate-400 hover:text-slate-600 transition-colors"
                      title={isEditingDescription ? "Save description" : "Edit description"}
                    >
                      <EditIcon className="w-3 h-3" />
                    </button>
                  </div>

                  {showDescription && (
                    <div className="mt-2">
                      {isEditingDescription ? (
                        <div className="space-y-2">
                          <textarea
                            value={tempDescription}
                            onChange={(e) => setTempDescription(e.target.value)}
                            onKeyDown={handleDescriptionKeyPress}
                            placeholder="Add a description for this task..."
                            className="w-full text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500 focus:border-blue-500"
                            rows={3}
                            autoFocus
                          />
                          <div className="flex gap-2">
                            <button
                              onClick={handleDescriptionEdit}
                              className="px-3 py-1 text-sm bg-blue-500 text-white rounded-md hover:bg-blue-600"
                            >
                              Save
                            </button>
                            <button
                              onClick={() => {
                                setTempDescription(task.description || '');
                                setIsEditingDescription(false);
                              }}
                              className="px-3 py-1 text-sm bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300"
                            >
                              Cancel
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div className="text-sm text-slate-600 bg-slate-50 p-2 rounded-md">
                          {task.description || <em className="text-slate-400">No description added yet. Click edit to add one.</em>}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>
            {isTopThree && (
              <div className="mt-3 space-y-3">
                <div className="grid grid-cols-2 gap-2">
                  <input
                    type="time"
                    value={task.scheduledTime || ''}
                    onChange={(e) => handleToggle('scheduledTime', e.target.value)}
                    className="block w-full text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500 focus:border-blue-500"
                  />
                  <select
                    value={task.duration || 60}
                    onChange={(e) => handleToggle('duration', Number(e.target.value))}
                    className="block w-full text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="15">15 mins</option>
                    <option value="30">30 mins</option>
                    <option value="45">45 mins</option>
                    <option value="60">1 hour</option>
                    <option value="90">1.5 hours</option>
                    <option value="120">2 hours</option>
                  </select>
                </div>
                <button
                  onClick={handleAddToCalendar}
                  className="w-full flex items-center justify-center gap-2 p-2 rounded-md bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 hover:text-blue-600 transition-colors"
                >
                  <CalendarIcon className="w-5 h-5" />
                  <span>Add to Calendar</span>
                </button>
                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">Action Points & Notes</label>
                  <textarea
                    placeholder="Specific action steps for this priority task..."
                    value={task.notes || ''}
                    onChange={(e) => handleToggle('notes', e.target.value)}
                    rows={3}
                    className="block w-full text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <button
                  onClick={() => handleToggle('isIncomeGenerating', !task.isIncomeGenerating)}
                  className={`w-full flex items-center justify-center gap-2 px-3 py-2 text-sm rounded-md transition-colors ${
                    task.isIncomeGenerating ? 'bg-yellow-400 text-yellow-900 hover:bg-yellow-500' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'
                  }`}
                >
                  <DollarSignIcon className="w-4 h-4" />
                  <span>Income-Generating Activity</span>
                </button>
              </div>
            )}

            {/* Action Buttons - Horizontal layout at bottom for Brain Dump tasks */}
            {(onPromote || onDemote || onSendToVault || onLaunchGemini || onDelete) && (
              <div className="mt-3 pt-3 border-t border-slate-200 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  {onPromote && (
                    <button
                      onClick={onPromote}
                      title="Promote to Top 3"
                      className="flex items-center gap-1 px-2 py-1 text-xs font-medium text-green-700 bg-green-50 rounded-md hover:bg-green-100 transition-colors"
                    >
                      <ArrowUpCircleIcon className="w-4 h-4" />
                      <span>Promote</span>
                    </button>
                  )}
                  {onDemote && (
                    <button
                      onClick={onDemote}
                      title="Demote to Brain Dump"
                      className="flex items-center gap-1 px-2 py-1 text-xs font-medium text-yellow-700 bg-yellow-50 rounded-md hover:bg-yellow-100 transition-colors"
                    >
                      <ArrowDownCircleIcon className="w-4 h-4" />
                      <span>Demote</span>
                    </button>
                  )}
                  {onSendToVault && (
                    <button
                      onClick={onSendToVault}
                      title="Send to Ideas Vault"
                      className="flex items-center gap-1 px-2 py-1 text-xs font-medium text-purple-700 bg-purple-50 rounded-md hover:bg-purple-100 transition-colors"
                    >
                      <LightbulbIcon className="w-4 h-4" />
                      <span>To Vault</span>
                    </button>
                  )}
                  {onLaunchGemini && (
                    <button
                      onClick={onLaunchGemini}
                      title="Work with AI"
                      className="flex items-center gap-1 px-2 py-1 text-xs font-medium text-blue-700 bg-blue-50 rounded-md hover:bg-blue-100 transition-colors"
                    >
                      <SparkleIcon className="w-4 h-4" />
                      <span>AI Help</span>
                    </button>
                  )}
                </div>
                <button
                  onClick={onDelete}
                  title="Delete Task"
                  className="flex items-center gap-1 px-2 py-1 text-xs font-medium text-red-700 bg-red-50 rounded-md hover:bg-red-100 transition-colors"
                >
                  <TrashIcon className="w-4 h-4" />
                  <span>Delete</span>
                </button>
              </div>
            )}
          </div>
        );
      };

      // Non-Negotiable Tasks Component (enhanced with description editing)
      const NonNegotiableTasks = ({ tasks, onUpdateTask }) => {
        const [editingStates, setEditingStates] = useState({});
        const [tempValues, setTempValues] = useState({});

        const handleEditToggle = (taskId, field) => {
          const key = `${taskId}-${field}`;
          const task = tasks.find(t => t.id === taskId);

          if (editingStates[key]) {
            // Save the changes
            const newValue = tempValues[key];
            if (field === 'text' && !newValue?.trim()) {
              // Don't allow empty titles
              setTempValues(prev => ({ ...prev, [key]: task[field] }));
            } else {
              onUpdateTask({ ...task, [field]: newValue || '' });
            }
            setEditingStates(prev => ({ ...prev, [key]: false }));
          } else {
            // Start editing
            setTempValues(prev => ({ ...prev, [key]: task[field] || '' }));
            setEditingStates(prev => ({ ...prev, [key]: true }));
          }
        };

        const handleKeyPress = (e, taskId, field) => {
          if (e.key === 'Enter' && field === 'text') {
            handleEditToggle(taskId, field);
          } else if (e.key === 'Escape') {
            const key = `${taskId}-${field}`;
            const task = tasks.find(t => t.id === taskId);
            setTempValues(prev => ({ ...prev, [key]: task[field] || '' }));
            setEditingStates(prev => ({ ...prev, [key]: false }));
          }
        };

        const updateTempValue = (taskId, field, value) => {
          const key = `${taskId}-${field}`;
          setTempValues(prev => ({ ...prev, [key]: value }));
        };
        const handleAddToCalendar = (task) => {
          if (!task.scheduledTime || task.scheduledTime.match(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/) === null) {
            alert("Please set a valid time for the task first.");
            return;
          }

          const [hours, minutes] = task.scheduledTime.split(':').map(Number);
          const startTime = new Date();
          startTime.setHours(hours, minutes, 0, 0);
          const durationMinutes = task.duration || 60;
          const endTime = new Date(startTime.getTime() + durationMinutes * 60 * 1000);

          const toGoogleFormat = (date) => {
            return date.toISOString().replace(/-|:|\.\d{3}/g, '');
          };

          const calendarUrl = new URL('https://www.google.com/calendar/render');
          calendarUrl.searchParams.append('action', 'TEMPLATE');
          calendarUrl.searchParams.append('text', task.text);
          calendarUrl.searchParams.append('dates', `${toGoogleFormat(startTime)}/${toGoogleFormat(endTime)}`);
          calendarUrl.searchParams.append('details', task.notes || `Completing task: ${task.text}`);
          calendarUrl.searchParams.append('crm', 'BUSY');

          window.open(calendarUrl.toString() + '&colorId=11', '_blank', 'noopener,noreferrer');
        };

        return (
          <div className="space-y-4">
            {tasks.map(task => {
              const titleKey = `${task.id}-text`;
              const descKey = `${task.id}-description`;
              const isEditingTitle = editingStates[titleKey];
              const isEditingDesc = editingStates[descKey];

              return (
                <div key={task.id} className="p-4 rounded-lg bg-slate-50 border border-slate-200">
                  <div className="flex items-start gap-4">
                    <input
                      type="checkbox"
                      checked={task.isCompleted}
                      onChange={(e) => onUpdateTask({ ...task, isCompleted: e.target.checked })}
                      className="mt-1 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 shrink-0"
                    />
                    <div className="flex-1">
                      <div className="flex items-start gap-2 mb-2">
                        {isEditingTitle ? (
                          <input
                            type="text"
                            value={tempValues[titleKey] || ''}
                            onChange={(e) => updateTempValue(task.id, 'text', e.target.value)}
                            onBlur={() => handleEditToggle(task.id, 'text')}
                            onKeyDown={(e) => handleKeyPress(e, task.id, 'text')}
                            className="flex-1 font-medium text-slate-800 bg-white border border-blue-500 rounded px-2 py-1 focus:outline-none"
                            autoFocus
                          />
                        ) : (
                          <p className="flex-1 font-medium text-slate-800">{task.text}</p>
                        )}
                        <button
                          onClick={() => handleEditToggle(task.id, 'text')}
                          className="p-1 text-slate-400 hover:text-slate-600 transition-colors"
                          title={isEditingTitle ? "Save title" : "Edit title"}
                        >
                          <EditIcon className="w-4 h-4" />
                        </button>
                      </div>

                      {/* Description Section */}
                      <div className="mb-3">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="text-xs text-slate-500">Description:</span>
                          <button
                            onClick={() => handleEditToggle(task.id, 'description')}
                            className="p-1 text-slate-400 hover:text-slate-600 transition-colors"
                            title={isEditingDesc ? "Save description" : "Edit description"}
                          >
                            <EditIcon className="w-3 h-3" />
                          </button>
                        </div>

                        {isEditingDesc ? (
                          <div className="space-y-2">
                            <textarea
                              value={tempValues[descKey] || ''}
                              onChange={(e) => updateTempValue(task.id, 'description', e.target.value)}
                              onKeyDown={(e) => handleKeyPress(e, task.id, 'description')}
                              placeholder="Add description for this non-negotiable task..."
                              className="w-full text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500 focus:border-blue-500"
                              rows={2}
                              autoFocus
                            />
                            <div className="flex gap-2">
                              <button
                                onClick={() => handleEditToggle(task.id, 'description')}
                                className="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600"
                              >
                                Save
                              </button>
                              <button
                                onClick={() => {
                                  setTempValues(prev => ({ ...prev, [descKey]: task.description || '' }));
                                  setEditingStates(prev => ({ ...prev, [descKey]: false }));
                                }}
                                className="px-2 py-1 text-xs bg-slate-200 text-slate-700 rounded hover:bg-slate-300"
                              >
                                Cancel
                              </button>
                            </div>
                          </div>
                        ) : (
                          <div className="text-sm text-slate-600 bg-white p-2 rounded border">
                            {task.description || <em className="text-slate-400">No description added yet.</em>}
                          </div>
                        )}
                      </div>
                    </div>

                    <div className="flex items-center gap-2">
                      <input
                        type="time"
                        value={task.scheduledTime || ''}
                        onChange={(e) => onUpdateTask({ ...task, scheduledTime: e.target.value })}
                        className="block w-32 text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500 focus:border-blue-500"
                      />
                      <button
                        onClick={() => handleAddToCalendar(task)}
                        title="Add to Google Calendar"
                        className="p-2 rounded-md bg-white border border-slate-300 text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled={!task.scheduledTime}
                      >
                        <CalendarIcon className="w-5 h-5" />
                      </button>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        );
      };

      // Ideas Vault List Component (enhanced with description editing)
      const IdeasVaultList = ({ ideas, onUpdateIdea, onReorderIdea, onCopyFromVault, onDeleteIdea }) => {
        const [editingStates, setEditingStates] = useState({});
        const [tempValues, setTempValues] = useState({});

        const handleEditToggle = (ideaId, field) => {
          const key = `${ideaId}-${field}`;
          const idea = ideas.find(i => i.id === ideaId);

          if (editingStates[key]) {
            // Save the changes
            const newValue = tempValues[key];
            if (field === 'text' && !newValue?.trim()) {
              // Don't allow empty titles
              setTempValues(prev => ({ ...prev, [key]: idea[field] }));
            } else {
              onUpdateIdea({ ...idea, [field]: newValue || '' });
            }
            setEditingStates(prev => ({ ...prev, [key]: false }));
          } else {
            // Start editing
            setTempValues(prev => ({ ...prev, [key]: idea[field] || '' }));
            setEditingStates(prev => ({ ...prev, [key]: true }));
          }
        };

        const handleKeyPress = (e, ideaId, field) => {
          if (e.key === 'Enter' && field === 'text') {
            handleEditToggle(ideaId, field);
          } else if (e.key === 'Escape') {
            const key = `${ideaId}-${field}`;
            const idea = ideas.find(i => i.id === ideaId);
            setTempValues(prev => ({ ...prev, [key]: idea[field] || '' }));
            setEditingStates(prev => ({ ...prev, [key]: false }));
          }
        };

        const updateTempValue = (ideaId, field, value) => {
          const key = `${ideaId}-${field}`;
          setTempValues(prev => ({ ...prev, [key]: value }));
        };

        return (
          <div className="space-y-4">
            {ideas.map((idea, index) => {
              const titleKey = `${idea.id}-text`;
              const descKey = `${idea.id}-description`;
              const isEditingTitle = editingStates[titleKey];
              const isEditingDesc = editingStates[descKey];

              return (
                <div key={idea.id} className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                  <div className="flex items-start gap-3">
                    <div className="flex-1">
                      <div className="flex items-start gap-2 mb-2">
                        {isEditingTitle ? (
                          <input
                            type="text"
                            value={tempValues[titleKey] || ''}
                            onChange={(e) => updateTempValue(idea.id, 'text', e.target.value)}
                            onBlur={() => handleEditToggle(idea.id, 'text')}
                            onKeyDown={(e) => handleKeyPress(e, idea.id, 'text')}
                            className="flex-1 font-medium text-slate-800 bg-white border border-blue-500 rounded px-2 py-1 focus:outline-none"
                            autoFocus
                          />
                        ) : (
                          <p className="flex-1 font-medium text-slate-700">{idea.text}</p>
                        )}
                        <button
                          onClick={() => handleEditToggle(idea.id, 'text')}
                          className="p-1 text-slate-400 hover:text-slate-600 transition-colors"
                          title={isEditingTitle ? "Save title" : "Edit title"}
                        >
                          <EditIcon className="w-4 h-4" />
                        </button>
                      </div>

                      {/* Description Section */}
                      <div className="mb-3">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="text-xs text-slate-500">Description:</span>
                          <button
                            onClick={() => handleEditToggle(idea.id, 'description')}
                            className="p-1 text-slate-400 hover:text-slate-600 transition-colors"
                            title={isEditingDesc ? "Save description" : "Edit description"}
                          >
                            <EditIcon className="w-3 h-3" />
                          </button>
                        </div>

                        {isEditingDesc ? (
                          <div className="space-y-2">
                            <textarea
                              value={tempValues[descKey] || ''}
                              onChange={(e) => updateTempValue(idea.id, 'description', e.target.value)}
                              onKeyDown={(e) => handleKeyPress(e, idea.id, 'description')}
                              placeholder="Add description for this idea..."
                              className="w-full text-sm p-2 rounded-md border-slate-300 focus:ring-blue-500 focus:border-blue-500"
                              rows={2}
                              autoFocus
                            />
                            <div className="flex gap-2">
                              <button
                                onClick={() => handleEditToggle(idea.id, 'description')}
                                className="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600"
                              >
                                Save
                              </button>
                              <button
                                onClick={() => {
                                  setTempValues(prev => ({ ...prev, [descKey]: idea.description || '' }));
                                  setEditingStates(prev => ({ ...prev, [descKey]: false }));
                                }}
                                className="px-2 py-1 text-xs bg-slate-200 text-slate-700 rounded hover:bg-slate-300"
                              >
                                Cancel
                              </button>
                            </div>
                          </div>
                        ) : (
                          <div className="text-sm text-slate-600 bg-white p-2 rounded border">
                            {idea.description || <em className="text-slate-400">No description added yet.</em>}
                          </div>
                        )}
                      </div>
                    </div>

                    <div className="flex items-center gap-2">
                      <div className="flex items-center gap-1">
                        <button
                          onClick={() => onReorderIdea(idea.id, 'up')}
                          disabled={index === 0}
                          title="Move Up"
                          className="p-1 rounded-md text-slate-500 hover:bg-slate-200 disabled:opacity-30 disabled:cursor-not-allowed"
                        >
                          <ChevronUpIcon className="w-5 h-5" />
                        </button>
                        <button
                          onClick={() => onReorderIdea(idea.id, 'down')}
                          disabled={index === ideas.length - 1}
                          title="Move Down"
                          className="p-1 rounded-md text-slate-500 hover:bg-slate-200 disabled:opacity-30 disabled:cursor-not-allowed"
                        >
                          <ChevronDownIcon className="w-5 h-5" />
                        </button>
                      </div>
                      <div className="h-6 border-l border-slate-300"></div>
                      <button
                        onClick={() => onCopyFromVault(idea.id)}
                        title="Copy to Brain Dump"
                        className="p-1 text-blue-600 hover:text-blue-800"
                      >
                        <RestoreIcon className="w-5 h-5" />
                      </button>
                      <button
                        onClick={() => onDeleteIdea(idea.id)}
                        title="Delete Idea Permanently"
                        className="p-1 text-red-600 hover:text-red-800"
                      >
                        <TrashIcon className="w-5 h-5" />
                      </button>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        );
      };

      // Main App Component
      const NON_NEGOTIABLE_TASKS_BASE = [
        { id: 'nn-prospecting', text: 'Prospecting Min 1 hr', isIncomeGenerating: true, duration: 60 },
        { id: 'nn-linkedin', text: 'Linkedin Post and commenting Min 1 hr', isIncomeGenerating: false, duration: 60 },
      ];

      const App = () => {
        const todayStr = new Date().toISOString().split('T')[0];
        const [brainDump, setBrainDump] = useLocalStorage('timeboxing-brainDump', []);
        const [topThree, setTopThree] = useLocalStorage(`timeboxing-topThree_${todayStr}`, []);
        const [completedHistory, setCompletedHistory] = useLocalStorage('timeboxing-completedHistory', []);
        const [ideasVault, setIdeasVault] = useLocalStorage('timeboxing-ideasVault', []);

        const [lapsHistory, setLapsHistory] = useLocalStorage('lapsHistory', []);
        const [accountabilityHistory, setAccountabilityHistory] = useLocalStorage('accountability-history', []);

        const [nonNegotiableTasks, setNonNegotiableTasks] = useLocalStorage(
          `timeboxing-nonNegotiable_${todayStr}`,
          NON_NEGOTIABLE_TASKS_BASE.map(task => ({
            ...task,
            isCompleted: false,
            scheduledTime: '',
            notes: '',
            description: '',
          }))
        );

        const [newTaskText, setNewTaskText] = useState('');
        const [showCompleted, setShowCompleted] = useState(false);
        const [showIdeasVault, setShowIdeasVault] = useState(false);
        const [showReports, setShowReports] = useState(false);
        const [geminiTask, setGeminiTask] = useState(null);

        const handleAddTask = (e) => {
          e.preventDefault();
          if (newTaskText.trim() === '') return;
          const newTask = {
            id: generateUUID(),
            text: newTaskText,
            isCompleted: false,
            isIncomeGenerating: false,
            notes: '',
            description: '',
            scheduledTime: '',
            duration: 60,
          };
          setBrainDump(prev => [newTask, ...prev]);
          setNewTaskText('');
        };

        const handleUpdateTask = useCallback((updatedTask) => {
          if (updatedTask.isCompleted) {
            const taskToArchive = { ...updatedTask, completedAt: new Date().toISOString() };
            setCompletedHistory(prev => [taskToArchive, ...prev]);
            setBrainDump(prev => prev.filter(t => t.id !== updatedTask.id));
            setTopThree(prev => prev.filter(t => t.id !== updatedTask.id));
          } else {
            setBrainDump(prev => prev.map(t => t.id === updatedTask.id ? updatedTask : t));
            setTopThree(prev => prev.map(t => t.id === updatedTask.id ? updatedTask : t));
          }
        }, [setBrainDump, setTopThree, setCompletedHistory]);

        const handleUpdateNonNegotiableTask = useCallback((updatedTask) => {
          setNonNegotiableTasks(prev => prev.map(t => t.id === updatedTask.id ? updatedTask : t));
        }, [setNonNegotiableTasks]);

        const handleDeleteTask = (id, listSetter) => {
          if (window.confirm("Are you sure you want to permanently delete this item?")) {
            listSetter(prev => prev.filter(t => t.id !== id));
          }
        };

        const promoteTask = (id) => {
          if (topThree.length >= 3) {
            alert("You can only have 3 top tasks. Demote one first.");
            return;
          }
          const taskToPromote = brainDump.find(t => t.id === id);
          if (taskToPromote) {
            setTopThree(prev => [...prev, taskToPromote]);
            setBrainDump(prev => prev.filter(t => t.id !== id));
          }
        };

        const demoteTask = (id) => {
          const taskToDemote = topThree.find(t => t.id === id);
          if (taskToDemote) {
            setBrainDump(prev => [taskToDemote, ...prev]);
            setTopThree(prev => prev.filter(t => t.id !== id));
          }
        };

        const restoreTask = (id) => {
          const taskToRestore = completedHistory.find(t => t.id === id);
          if (taskToRestore) {
            const restoredTask = { ...taskToRestore, isCompleted: false, completedAt: undefined };
            setBrainDump(prev => [restoredTask, ...prev]);
            setCompletedHistory(prev => prev.filter(t => t.id !== id));
          }
        };

        const handleSendToVault = (id) => {
          const taskToVault = brainDump.find(t => t.id === id);
          if (taskToVault) {
            // Preserve the description when sending to vault
            const vaultTask = {
              id: taskToVault.id,
              text: taskToVault.text,
              description: taskToVault.description || ''
            };
            setIdeasVault(prev => [vaultTask, ...prev]);
            setBrainDump(prev => prev.filter(t => t.id !== id));
          }
        };

        const handleCopyFromVault = (id) => {
          const taskToCopy = ideasVault.find(t => t.id === id);
          if (taskToCopy) {
            const newActionableTask = {
              ...taskToCopy,
              id: generateUUID(),
              isCompleted: false,
              isIncomeGenerating: false,
              notes: '',
              scheduledTime: '',
              duration: 60,
              // Preserve the description from the vault
              description: taskToCopy.description || ''
            };
            setBrainDump(prev => [newActionableTask, ...prev]);
            alert(`Copied "${taskToCopy.text}" to Brain Dump.`);
          }
        };

        const handleReorderIdea = (id, direction) => {
          setIdeasVault(prev => {
            const index = prev.findIndex(t => t.id === id);
            if (index === -1) return prev;

            if (direction === 'up' && index > 0) {
              const newVault = [...prev];
              [newVault[index - 1], newVault[index]] = [newVault[index], newVault[index - 1]];
              return newVault;
            }
            if (direction === 'down' && index < prev.length - 1) {
              const newVault = [...prev];
              [newVault[index + 1], newVault[index]] = [newVault[index], newVault[index + 1]];
              return newVault;
            }
            return prev;
          });
        };

        const startNewDay = () => {
          if (window.confirm("Are you sure you want to end the day? Incomplete priorities will be returned to your Brain Dump.")) {
            const incompleteTasks = topThree.filter(t => !t.isCompleted);

            if (incompleteTasks.length > 0) {
              // Clear the scheduled time and notes for demoted tasks
              const tasksToDemote = incompleteTasks.map(t => ({
                ...t,
                scheduledTime: '',
                notes: '',
                isIncomeGenerating: false // Reset this too for fresh start
              }));

              // Add incomplete tasks back to brain dump
              setBrainDump(prev => [...tasksToDemote, ...prev]);
            }

            // Clear the top three priorities
            setTopThree([]);

            // Clear completed history for the day (optional - you might want to keep this)
            // setCompletedHistory([]);

            // Give a moment for state to update before reload
            setTimeout(() => {
              window.location.reload();
            }, 100);
          }
        };

        const dayOfWeek = new Date().getDay();
        const isWeekday = dayOfWeek > 0 && dayOfWeek < 6;

        const handleLaunchGemini = (task) => setGeminiTask(task);
        const handleCloseGemini = () => setGeminiTask(null);

        return (
          <div className="min-h-screen bg-slate-100">
            <header className="bg-white shadow-sm sticky top-0 z-20">
              <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <h1 className="text-2xl font-bold text-slate-800">Momentum Tracker</h1>
                </div>
                <div className="flex items-center gap-3">
                  <button
                    onClick={() => exportUncompletedTasks(brainDump, topThree, nonNegotiableTasks, ideasVault)}
                    className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-green-600 bg-green-50 rounded-md hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                    title="Export all uncompleted tasks from all sections to CSV"
                  >
                    <DownloadIcon className="w-4 h-4" />
                    Export Uncompleted
                  </button>
                  <button
                    onClick={() => exportAllData(lapsHistory, accountabilityHistory, completedHistory, brainDump, topThree, ideasVault)}
                    className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-md hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    title="Export all your data to CSV"
                  >
                    <DownloadIcon className="w-4 h-4" />
                    Export All Data
                  </button>
                  <button
                    onClick={startNewDay}
                    className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                  >
                    Start New Day
                  </button>
                </div>
              </div>
            </header>
            <main className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
              <Instructions />

              <section aria-labelledby="top-3-heading" className="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 id="top-3-heading" className="text-2xl font-bold text-slate-800 mb-4">⭐ Top 3 Priorities</h2>
                <div className="space-y-4">
                  {topThree.length > 0 ? (
                    topThree.map(task => (
                      <TaskCard
                        key={task.id}
                        task={task}
                        onUpdate={handleUpdateTask}
                        onDelete={() => handleDeleteTask(task.id, setTopThree)}
                        onDemote={() => demoteTask(task.id)}
                        onLaunchGemini={() => handleLaunchGemini(task)}
                        isTopThree={true}
                      />
                    ))
                  ) : (
                    <p className="text-slate-500 text-center py-4">Promote tasks from your brain dump to focus on them.</p>
                  )}
                  {topThree.length < 3 && Array.from({ length: 3 - topThree.length }).map((_, i) => (
                    <div key={i} className="p-4 rounded-lg border-2 border-dashed border-slate-300 text-center text-slate-400" aria-hidden="true">
                      Empty Priority Slot
                    </div>
                  ))}
                </div>
              </section>

              {isWeekday && (
                <section aria-labelledby="non-negotiable-heading" className="bg-white p-6 rounded-lg shadow-md mb-8">
                  <h2 id="non-negotiable-heading" className="text-2xl font-bold text-slate-800 mb-4">🗓️ Daily Non-Negotiables</h2>
                  <NonNegotiableTasks
                    tasks={nonNegotiableTasks}
                    onUpdateTask={handleUpdateNonNegotiableTask}
                  />
                </section>
              )}

              <section aria-labelledby="brain-dump-heading" className="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 id="brain-dump-heading" className="text-2xl font-bold text-slate-800 mb-4">🧠 Brain Dump</h2>
                <form onSubmit={handleAddTask} className="flex gap-2 mb-4">
                  <input
                    type="text"
                    value={newTaskText}
                    onChange={(e) => setNewTaskText(e.target.value)}
                    placeholder="Add a new task..."
                    className="flex-grow block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"
                    aria-label="New task input"
                  />
                  <button type="submit" aria-label="Add new task" className="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 flex items-center justify-center">
                    <PlusIcon className="w-5 h-5" />
                  </button>
                </form>
                <div className="space-y-3 max-h-[45rem] overflow-y-auto pr-2">
                  {brainDump.length > 0 ? (
                    brainDump.map(task => (
                      <TaskCard
                        key={task.id}
                        task={task}
                        onUpdate={handleUpdateTask}
                        onDelete={() => handleDeleteTask(task.id, setBrainDump)}
                        onPromote={() => promoteTask(task.id)}
                        onSendToVault={() => handleSendToVault(task.id)}
                        onLaunchGemini={() => handleLaunchGemini(task)}
                        isTopThree={false}
                      />
                    ))
                  ) : (
                    <p className="text-slate-500 text-center py-4">Brain dump all your tasks for the day here.</p>
                  )}
                </div>
              </section>

              {/* Ideas Vault */}
              <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                <button
                  onClick={() => setShowIdeasVault(!showIdeasVault)}
                  className="w-full flex justify-between items-center text-left text-xl font-bold text-slate-800 focus:outline-none"
                >
                  <span>💡 Ideas Vault ({ideasVault.length})</span>
                  <ChevronDownIcon className={`w-6 h-6 transform transition-transform ${showIdeasVault ? 'rotate-180' : ''}`} />
                </button>
                {showIdeasVault && (
                  <div className="mt-4 pt-4 border-t">
                    {ideasVault.length > 0 ? (
                      <IdeasVaultList
                        ideas={ideasVault}
                        onUpdateIdea={(updatedIdea) => {
                          setIdeasVault(prev => prev.map(idea => idea.id === updatedIdea.id ? updatedIdea : idea));
                        }}
                        onReorderIdea={handleReorderIdea}
                        onCopyFromVault={handleCopyFromVault}
                        onDeleteIdea={(id) => handleDeleteTask(id, setIdeasVault)}
                      />
                    ) : (
                      <p className="text-slate-500 text-center py-4">Send ideas here to review later.</p>
                    )}
                  </div>
                )}
              </div>

              {/* Completed History */}
              <div className="bg-white p-6 rounded-lg shadow-md mb-8">
                <div className="flex justify-between items-center">
                  <button
                    onClick={() => setShowCompleted(!showCompleted)}
                    className="flex items-center text-left text-xl font-bold text-slate-800 focus:outline-none"
                  >
                    <span>✅ Completed Task History ({completedHistory.length})</span>
                    <ChevronDownIcon className={`w-6 h-6 ml-2 transform transition-transform ${showCompleted ? 'rotate-180' : ''}`} />
                  </button>
                  {completedHistory.length > 0 && (
                    <button
                      onClick={() => exportCompletedTasks(completedHistory)}
                      className="flex items-center gap-2 px-3 py-1 text-sm font-medium text-blue-600 bg-blue-50 rounded-md hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                      title="Export completed tasks to CSV"
                    >
                      <DownloadIcon className="w-4 h-4" />
                      Export CSV
                    </button>
                  )}
                </div>
                {showCompleted && completedHistory.length > 0 && (
                  <div className="mt-4 space-y-2">
                    {completedHistory.slice(0, 10).map(task => (
                      <div key={task.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <div>
                          <p className="font-medium text-slate-900">{task.text}</p>
                          <p className="text-sm text-slate-500">{new Date(task.completedAt).toLocaleString()}</p>
                        </div>
                        <div className="flex items-center gap-2">
                          <button onClick={() => restoreTask(task.id)} title="Restore Task" className="text-blue-600 hover:text-blue-800">
                            <RestoreIcon className="w-4 h-4" />
                          </button>
                          <button onClick={() => handleDeleteTask(task.id, setCompletedHistory)} title="Delete Permanently" className="text-red-600 hover:text-red-800">
                            <TrashIcon className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
                {showCompleted && completedHistory.length === 0 && (
                  <p className="mt-4 text-slate-500 text-center py-4">No completed tasks yet. Get to work!</p>
                )}
              </div>

              {/* LAPS Tracker */}
              <div className="mb-8">
                <LapsTracker lapsHistory={lapsHistory} setLapsHistory={setLapsHistory} />
              </div>

              {/* Accountability Tracker */}
              <div className="mb-8">
                <AccountabilityTracker accountabilityHistory={accountabilityHistory} setAccountabilityHistory={setAccountabilityHistory} />
              </div>

              {/* Performance Reports */}
              <div className="bg-white p-6 rounded-lg shadow-md">
                <button
                  onClick={() => setShowReports(!showReports)}
                  className="w-full flex justify-between items-center text-left text-xl font-bold text-slate-800 focus:outline-none"
                >
                  <span>📈 Performance Reports</span>
                  <ChevronDownIcon className={`w-6 h-6 transform transition-transform ${showReports ? 'rotate-180' : ''}`} />
                </button>
                {showReports && (
                  <div className="mt-6 border-t pt-6">
                    <Reports lapsHistory={lapsHistory} accountabilityHistory={accountabilityHistory} />
                  </div>
                )}
              </div>

            </main>

            {geminiTask && <GeminiModal task={geminiTask} onClose={handleCloseGemini} />}
          </div>
        );
      };

      // Render the app
      const rootElement = document.getElementById('root');
      if (rootElement) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
      } else {
        console.error('Root element not found');
      }
    </script>
  </body>
</html>
